<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Markdown Reader</title>
  <style>
    :root{
      --bg: #0f141b;
      --bg-soft: #141b24;
      --panel: #1b2430;
      --panel-2: #202b3a;
      --text: #e6edf3;
      --muted: #a6b4c3;
      --accent: #7bdcb5;
      --accent-2: #66a3ff;
      --danger: #ff7b7b;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 14px;
      --mono: "Cascadia Mono", "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      --sans: "Space Grotesk", "Trebuchet MS", "Segoe UI", sans-serif;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(102,163,255,0.25), transparent 60%),
        radial-gradient(1000px 600px at 90% 10%, rgba(123,220,181,0.2), transparent 65%),
        var(--bg);
    }

    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:22px 28px 16px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(8px);
      background: rgba(15,20,27,0.75);
      position: sticky;
      top:0;
      z-index:10;
    }

    .title{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:22px;
      font-weight:600;
      letter-spacing:0.4px;
    }

    .title .badge{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:1px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .layout{
      flex:1;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px 22px 26px;
    }

    aside{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .sidebar-head{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
    }

    .sidebar-head .label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.9px;
      color: var(--muted);
      margin-bottom:8px;
    }

    .search{
      display:flex;
      align-items:center;
      gap:8px;
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
    }

    .search input{
      background: transparent;
      border: none;
      color: var(--text);
      width:100%;
      font-size:14px;
      outline:none;
    }

    .meta-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
    }

    .pill{
      padding:3px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,0.03);
    }

    .file-list{
      overflow:auto;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .file-item{
      border:1px solid transparent;
      border-radius:12px;
      padding:10px 12px;
      background: rgba(255,255,255,0.02);
      cursor:pointer;
      transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .file-item:hover{
      border-color: rgba(123,220,181,0.4);
      transform: translateY(-1px);
      background: rgba(123,220,181,0.08);
    }

    .file-item.active{
      border-color: rgba(102,163,255,0.8);
      background: rgba(102,163,255,0.15);
      box-shadow: inset 0 0 0 1px rgba(102,163,255,0.35);
    }

    .file-item .name{
      font-weight:600;
      font-size:14px;
    }

    .file-item .sub{
      margin-top:6px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:11px;
    }

    main{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .preview-head{
      padding:18px 20px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(32,43,58,0.5);
    }

    .preview-title{
      font-size:18px;
      font-weight:600;
    }

    .preview-meta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color: var(--muted);
      font-size:12px;
    }

    .preview{
      padding:18px 20px 32px;
      overflow:auto;
      min-height:0;
    }

    .empty{
      color: var(--muted);
      font-size:14px;
      padding:18px;
      border:1px dashed var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.02);
    }

    .md h1, .md h2, .md h3, .md h4{
      margin:1.3em 0 0.6em;
      line-height:1.2;
    }

    .md h1{ font-size:28px; }
    .md h2{ font-size:22px; }
    .md h3{ font-size:18px; }
    .md h4{ font-size:16px; }

    .md p{ line-height:1.6; margin:0.6em 0; }
    .md code{ font-family: var(--mono); font-size:0.92em; background: rgba(255,255,255,0.08); padding:2px 6px; border-radius:6px; }
    .md pre{ background: #0b1118; border:1px solid var(--border); border-radius:12px; padding:14px; overflow:auto; }
    .md pre code{ background: transparent; padding:0; }
    .md blockquote{ border-left:3px solid var(--accent-2); margin:1em 0; padding:0.4em 0.8em; color: var(--muted); background: rgba(102,163,255,0.08); }
    .md ul, .md ol{ padding-left:1.2em; margin:0.6em 0; }
    .md hr{ border:none; border-top:1px solid var(--border); margin:1.4em 0; }
    .md a{ color: var(--accent-2); text-decoration:none; }
    .md a:hover{ text-decoration:underline; }

    .md table{
      width:100%;
      border-collapse:collapse;
      margin:1em 0 1.4em;
      font-size:14px;
    }

    .md th, .md td{
      border:1px solid var(--border);
      padding:8px 10px;
      text-align:left;
      vertical-align:top;
    }

    .md th{
      background: rgba(255,255,255,0.05);
      font-weight:600;
    }

    .status{
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .status.ok{ background: rgba(123,220,181,0.12); color: var(--accent); border:1px solid rgba(123,220,181,0.35); }
    .status.err{ background: rgba(255,123,123,0.12); color: var(--danger); border:1px solid rgba(255,123,123,0.35); }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      aside{ order:2; }
      main{ order:1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        Markdown Reader
        <span class="badge">/md</span>
      </div>
    </header>

    <div class="layout">
      <aside>
        <div class="sidebar-head">
          <div class="label">Files</div>
          <div class="search">
            <input id="searchInput" type="search" placeholder="Filter by filename or PN..." />
          </div>
          <div class="meta-row">
            <span class="pill" id="fileCount">Loading...</span>
            <span class="pill" id="dataStatus">Index: pending</span>
          </div>
        </div>
        <div class="file-list" id="fileList"></div>
      </aside>

      <main>
        <div class="preview-head">
          <div class="preview-title" id="previewTitle">Select a markdown file</div>
          <div class="preview-meta" id="previewMeta"></div>
          <div class="preview-meta" id="previewDebug"></div>
          <div class="preview-meta" id="previewLog"></div>
        </div>
        <div class="preview" id="previewPane">
          <div class="empty" id="emptyState">Pick a file from the left to render its markdown.</div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const state = {
      entries: [],
      filtered: [],
      current: null,
      requestId: 0
    };

    const $ = (id) => document.getElementById(id);

    function logDebug(msg){
      const ts = new Date().toLocaleTimeString();
      const line = `[${ts}] ${msg}`;
      const el = $("previewLog");
      if(!el) return;
      const current = el.getAttribute("data-log") || "";
      const next = (line + "\\n" + current).trim().split("\\n").slice(0, 5).join("\\n");
      el.setAttribute("data-log", next);
      el.textContent = next;
    }

    function getHashPath(){
      const raw = decodeURIComponent(location.hash.replace(/^#/, ""));
      return raw.split("|")[0];
    }

    function setHashPath(path){
      const stamp = Date.now().toString(36);
      const next = encodeURIComponent(path || "") + "|" + stamp;
      history.replaceState(null, "", "#" + next);
    }

    function escapeHtml(str){
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function formatInline(text){
      let out = escapeHtml(text);
      out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
      out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      out = out.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      out = out.replace(/_([^_]+)_/g, '<em>$1</em>');
      out = out.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
      return out;
    }

    function parseTable(lines, startIdx){
      const header = lines[startIdx];
      const divider = lines[startIdx + 1] || "";
      if(!/^\s*\|?\s*[-:| ]+\|?\s*$/.test(divider)) return null;

      const rows = [];
      let i = startIdx;
      while(i < lines.length && /\|/.test(lines[i])){
        rows.push(lines[i]);
        i += 1;
      }

      const parseRow = (row) => {
        const trimmed = row.trim();
        const strip = trimmed.startsWith("|") ? trimmed.slice(1) : trimmed;
        const strip2 = strip.endsWith("|") ? strip.slice(0, -1) : strip;
        return strip2.split("|").map(cell => formatInline(cell.trim()));
      };

      const headCells = parseRow(rows[0]);
      const bodyRows = rows.slice(2).map(parseRow);

      let html = '<table><thead><tr>';
      html += headCells.map(cell => `<th>${cell}</th>`).join("");
      html += '</tr></thead><tbody>';
      html += bodyRows.map(cells => `<tr>${cells.map(c => `<td>${c}</td>`).join("")}</tr>`).join("");
      html += '</tbody></table>';

      return { html, nextIndex: i };
    }

    function markdownToHtml(md){
      const lines = md.replace(/\r\n?/g, "\n").split("\n");
      const blocks = [];
      let i = 0;

      while(i < lines.length){
        const line = lines[i];

        if(line.trim() === ""){
          i += 1;
          continue;
        }

        if(line.startsWith("```")){
          const lang = line.slice(3).trim();
          let code = "";
          i += 1;
          while(i < lines.length && !lines[i].startsWith("```")){
            code += lines[i] + "\n";
            i += 1;
          }
          i += 1;
          blocks.push(`<pre><code data-lang="${escapeHtml(lang)}">${escapeHtml(code)}</code></pre>`);
          continue;
        }

        const table = parseTable(lines, i);
        if(table){
          blocks.push(table.html);
          i = table.nextIndex;
          continue;
        }

        if(/^#{1,6}\s/.test(line)){
          const level = line.match(/^#{1,6}/)[0].length;
          const content = line.replace(/^#{1,6}\s*/, "");
          blocks.push(`<h${level}>${formatInline(content)}</h${level}>`);
          i += 1;
          continue;
        }

        if(/^>\s?/.test(line)){
          let quote = line.replace(/^>\s?/, "");
          i += 1;
          while(i < lines.length && /^>\s?/.test(lines[i])){
            quote += "\n" + lines[i].replace(/^>\s?/, "");
            i += 1;
          }
          blocks.push(`<blockquote>${formatInline(quote)}</blockquote>`);
          continue;
        }

        if(/^(-{3,}|\*{3,})$/.test(line.trim())){
          blocks.push("<hr />");
          i += 1;
          continue;
        }

        if(/^\s*([-*+]\s+)/.test(line)){
          const items = [];
          while(i < lines.length && /^\s*([-*+]\s+)/.test(lines[i])){
            items.push(lines[i].replace(/^\s*([-*+]\s+)/, ""));
            i += 1;
          }
          blocks.push(`<ul>${items.map(item => `<li>${formatInline(item)}</li>`).join("")}</ul>`);
          continue;
        }

        if(/^\s*\d+\.\s+/.test(line)){
          const items = [];
          while(i < lines.length && /^\s*\d+\.\s+/.test(lines[i])){
            items.push(lines[i].replace(/^\s*\d+\.\s+/, ""));
            i += 1;
          }
          blocks.push(`<ol>${items.map(item => `<li>${formatInline(item)}</li>`).join("")}</ol>`);
          continue;
        }

        let para = line;
        i += 1;
        while(i < lines.length && lines[i].trim() !== "" &&
          !/^#{1,6}\s/.test(lines[i]) &&
          !/^>\s?/.test(lines[i]) &&
          !/^\s*([-*+]\s+)/.test(lines[i]) &&
          !/^\s*\d+\.\s+/.test(lines[i]) &&
          !/^(-{3,}|\*{3,})$/.test(lines[i].trim()) &&
          !/^\s*\|/.test(lines[i])
        ){
          para += " " + lines[i].trim();
          i += 1;
        }
        blocks.push(`<p>${formatInline(para)}</p>`);
      }

      return blocks.join("\n");
    }

    function setStatus(ok, message){
      const el = $("dataStatus");
      el.textContent = message;
      el.className = ok ? "pill status ok" : "pill status err";
    }

    function renderList(){
      const list = $("fileList");
      list.innerHTML = "";
      if(!state.filtered.length){
        list.innerHTML = '<div class="empty">No files match the filter.</div>';
        return;
      }

      for(const entry of state.filtered){
        const item = document.createElement("div");
        item.className = "file-item" + (state.current && state.current.path === entry.path ? " active" : "");
        item.dataset.path = entry.path || "";
        item.dataset.filename = entry.filename || "";
        item.innerHTML = `
          <div class="name">${escapeHtml(entry.filename)}</div>
          <div class="sub">
            ${entry.pn ? `<span class="pill">${escapeHtml(entry.pn)}</span>` : ""}
            ${entry.rev ? `<span class="pill">${escapeHtml(entry.rev)}</span>` : ""}
            ${entry.kind ? `<span class="pill">${escapeHtml(entry.kind)}</span>` : ""}
          </div>
        `;
        item.addEventListener("click", () => selectEntry(entry));
        list.appendChild(item);
      }
    }

    function updateMeta(entry){
      const meta = $("previewMeta");
      meta.innerHTML = "";
      if(!entry){
        return;
      }
      const parts = [];
      if(entry.pn) parts.push(`PN: ${escapeHtml(entry.pn)}`);
      if(entry.rev) parts.push(`REV: ${escapeHtml(entry.rev)}`);
      if(entry.kind) parts.push(`KIND: ${escapeHtml(entry.kind)}`);
      if(entry.mtime) parts.push(`Updated: ${escapeHtml(entry.mtime)}`);
      meta.innerHTML = parts.map(p => `<span class="pill">${p}</span>`).join("");
    }

    async function selectEntry(entry){
      state.current = entry;
      const requestId = ++state.requestId;
      $("previewTitle").textContent = entry.filename;
      updateMeta(entry);
      $("previewDebug").textContent = `Path: ${entry.path || ""} | fetching...`;
      logDebug(`click -> ${entry.path || entry.filename || ""}`);
      $("emptyState").style.display = "none";
      $("previewPane").innerHTML = '<div class="empty">Loading...</div>';

      const timeoutMs = 6000;
      const timer = setTimeout(() => {
        if(requestId !== state.requestId) return;
        $("previewPane").innerHTML = '<div class="empty">Request timed out.</div>';
        $("previewDebug").textContent = `Error: Request timed out`;
        logDebug(`timeout -> ${entry.path || ""}`);
      }, timeoutMs);

      try{
        const url = entry.path + "?v=" + Date.now();
        logDebug(`fetch -> ${url}`);
        const res = await fetch(url, { cache: "no-store" });
        if(requestId !== state.requestId) return;
        clearTimeout(timer);
        if(!res.ok) throw new Error(`Failed to load ${entry.path} (${res.status})`);
        $("previewDebug").textContent = `Path: ${entry.path || ""} | status ${res.status}`;
        const text = await res.text();
        if(requestId !== state.requestId) return;
        const html = markdownToHtml(text);
        $("previewPane").innerHTML = `<div class="md" data-path="${escapeHtml(entry.path)}">${html}</div>`;
        $("previewDebug").textContent = `Path: ${entry.path || ""} | ${text.length} bytes | URL: ${res.url}`;
        logDebug(`render -> ${entry.path || ""} (${text.length} bytes)`);
        setHashPath(entry.path);
      }catch(err){
        if(requestId !== state.requestId) return;
        clearTimeout(timer);
        const msg = err?.message || "Unknown error";
        $("previewPane").innerHTML = `<div class="empty">${escapeHtml(msg)}</div>`;
        $("previewDebug").textContent = `Error: ${msg}`;
        logDebug(`error -> ${msg}`);
      }

      renderList();
    }
    function filterList(query){
      const q = query.trim().toLowerCase();
      if(!q){
        state.filtered = state.entries.slice();
      }else{
        state.filtered = state.entries.filter(e => {
          return [e.filename, e.pn, e.rev, e.kind].some(v => (v || "").toLowerCase().includes(q));
        });
      }
      $("fileCount").textContent = `${state.filtered.length} files`;
      renderList();
    }

    async function loadIndex(){
      try{
        const res = await fetch("md/index.json");
        if(!res.ok) throw new Error("Index not found");
        const data = await res.json();
        state.entries = Array.isArray(data.entries) ? data.entries.slice() : [];
        state.entries.sort((a, b) => (a.filename || "").localeCompare(b.filename || ""));
        setStatus(true, "Index: loaded");
      }catch(err){
        setStatus(false, "Index: missing");
        state.entries = [{
          path: "md/README.md",
          filename: "README.md",
          pn: "",
          rev: "",
          kind: "",
          mtime: ""
        }];
      }

      state.filtered = state.entries.slice();
      $("fileCount").textContent = `${state.filtered.length} files`;
      renderList();

      const hash = decodeURIComponent(location.hash.replace(/^#/, ""));
      const target = hash ? state.entries.find(e => e.path === hash || e.filename === hash) : state.entries[0];
      if(target){
        selectEntry(target);
      }
    }

    $("searchInput").addEventListener("input", (e) => filterList(e.target.value));
    $("fileList").addEventListener("click", (e) => {
      const item = e.target.closest(".file-item");
      if(!item) return;
      const path = item.dataset.path || "";
      const filename = item.dataset.filename || "";
      const entry = state.entries.find(e => e.path === path || e.filename === filename);
      if(entry) selectEntry(entry);
    });
    window.addEventListener("hashchange", () => {
      const hashPath = getHashPath();
      const target = state.entries.find(e => e.path === hashPath || e.filename === hashPath);
      if(target && (!state.current || target.path !== state.current.path)) selectEntry(target);
    });

    loadIndex();
  </script>
</body>
</html>
