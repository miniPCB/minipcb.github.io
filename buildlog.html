<!DOCTYPE html>

<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9ZM2D6XGT2">
</script>
<script>
   window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-9ZM2D6XGT2');
  </script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>
   Engineering Build Log – miniPCB™
  </title>
<link href="styles.css" rel="stylesheet"/>
<link href="favicon.png" rel="icon" type="image/png"/>
<meta content="miniPCB, Engineering Build Log, PCB Design, Hardware Engineering, Electronic Components, Change Management, Circuit Board, Change Log, Engineering Updates, PCB Updates, Product Engineering, PCB Engineering, Change Control, Engineering Control, Design Modifications, PCB Modifications, Engineering Change Notice, Miniature PCB, Electronics Engineering, PCB Change Log" name="keywords"/>
</head>
<body>
<nav>
<div class="nav-container">
<ul class="nav-links">
<li>
<a href="index.html">
       Home
      </a>
</li>
</ul>
</div>
</nav>
<main class="container">
<h1>Engineering Build Log</h1>
<p>This log documents engineering builds of miniPCB™ circuit boards.</p>
<div class="toolbar">
  <label for="statusFilter">Filter by status:</label>
  <select id="statusFilter">
    <!-- options will be populated dynamically -->
  </select>
</div>
<table class="changelog-table" id="ebl-table">
<thead>
    <tr>
      <th>Date</th>
      <th>Board</th>
      <th>Rev</th>
      <th>Title</th>
      <th>Status</th>
    </tr>
</thead>
<tbody>
<!-- rows will be inserted here dynamically -->
</tbody>
</table>
</main>
<footer>
   © 2025 miniPCB. All rights reserved.
  </footer>
<button id="backToTop" onclick="scrollToTop()" title="Back to Top">
   ↑
  </button>
<script>
  document.addEventListener("DOMContentLoaded", initEBL);

  async function initEBL() {
    const tbody = document.querySelector("#ebl-table tbody");
    const statusSelect = document.getElementById("statusFilter");
    if (!tbody || !statusSelect) return;

    try {
      const res = await fetch("EBL.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const raw = await res.json();
      if (!Array.isArray(raw) || raw.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">No builds logged yet.</td></tr>`;
        return;
      }

      // Normalize fields and sort newest first
      const items = raw.map(e => ({
        date: (e.build_date ?? e.date ?? "").trim(),
        board: (e.board ?? "").trim(),
        rev: (e.rev ?? "").trim(),
        title: (e.title ?? e.change ?? "").trim(),
        link: (e.link ?? "").trim(),
        status: (e.status ?? "").trim()
      })).sort((a, b) => {
        const ad = Date.parse(a.date || "");
        const bd = Date.parse(b.date || "");
        return (isNaN(bd) ? 0 : bd) - (isNaN(ad) ? 0 : ad);
      });

      // Build status filter options from data (ordered logically)
      const ordering = ["not planned", "planned", "in-progress", "complete"];
      const unique = Array.from(
        new Set(items.map(x => x.status.toLowerCase()).filter(Boolean))
      ).sort((a, b) => (idx(a, ordering) - idx(b, ordering)) || a.localeCompare(b));
      statusSelect.innerHTML =
        `<option value="">All statuses</option>` +
        unique.map(s => `<option value="${s}">${toTitle(s)}</option>`).join("");

      // Initial render and live filtering
      renderRows(tbody, items, getSelected(statusSelect));
      statusSelect.addEventListener("change", () => {
        renderRows(tbody, items, getSelected(statusSelect));
      });
    } catch (err) {
      console.error("Failed to load EBL.json:", err);
      tbody.innerHTML = `<tr><td colspan="5">Failed to load build log.</td></tr>`;
    }
  }

  function renderRows(tbody, items, statusFilter) {
    const frag = document.createDocumentFragment();
    let shown = 0;

    items.forEach(entry => {
      const s = (entry.status || "").toLowerCase();
      if (statusFilter && s !== statusFilter) return;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHTML(entry.date)}</td>
        <td>${escapeHTML(entry.board)}</td>
        <td>${escapeHTML(entry.rev)}</td>
        <td>${entry.link ? `<a href="${encodeURI(entry.link)}">${escapeHTML(entry.title)}</a>` : escapeHTML(entry.title)}</td>
        <td>${escapeHTML(entry.status)}</td>
      `;
      frag.appendChild(tr);
      shown++;
    });

    tbody.innerHTML = "";
    tbody.appendChild(shown ? frag : emptyRow(5, "No builds match this filter."));
  }

  function getSelected(sel) {
    return (sel?.value || "").toLowerCase();
  }

  function idx(s, ordering) {
    const i = ordering.indexOf(s);
    return i === -1 ? 999 : i;
  }

  function toTitle(s) {
    return s.replace(/\b\w/g, c => c.toUpperCase());
  }

  function emptyRow(cols, msg) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="${cols}">${escapeHTML(msg)}</td>`;
    return tr;
  }

  function escapeHTML(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }
</script>

<script>
   function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.onscroll = function () {
    const btn = document.getElementById("backToTop");
    if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
      btn.style.display = "block";
    } else {
      btn.style.display = "none";
    }
  };
  </script>
</body>
</html>
