{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://minipcb.com/schemas/netlist.schema.v1.1.json",
  "title": "miniPCB Netlist Schema v1.1",
  "type": "object",

  "required": ["schema_version", "identity", "metadata", "components", "nets"],

  "properties": {
    "schema_version": {
      "type": "string",
      "enum": ["1.1"]
    },

    "identity": {
      "type": "object",
      "required": ["board_pn", "board_rev", "board_type"],
      "properties": {
        "board_pn": { "type": "string", "minLength": 1 },
        "board_rev": { "type": "string", "minLength": 1 },
        "board_type": {
          "type": "string",
          "enum": ["pcb", "schematic", "combined"]
        }
      },
      "additionalProperties": false
    },

    "metadata": {
      "type": "object",
      "required": ["project_name", "revision"],
      "properties": {
        "project_name": { "type": "string" },
        "revision": { "type": "string" },
        "source_tool": { "type": "string" },
        "generated_on": { "type": "string", "format": "date-time" },
        "units": { "type": "string" }
      },
      "additionalProperties": true
    },

    "components": {
      "type": "array",
      "items": { "$ref": "#/$defs/component" }
    },

    "nets": {
      "type": "array",
      "items": { "$ref": "#/$defs/net" }
    },

    "sheets": {
      "type": "array",
      "items": { "$ref": "#/$defs/sheet" }
    },

    "logical_blocks": {
      "type": "array",
      "items": { "$ref": "#/$defs/logical_block" }
    },

    "test_integration": {
      "$ref": "#/$defs/test_integration"
    },

    "ports": {
      "type": "array",
      "items": { "$ref": "#/$defs/port" }
    },

    "analysis": {
      "$ref": "#/$defs/analysis"
    }
  },

  "unevaluatedProperties": false,

  "allOf": [
    {
      "if": {
        "properties": {
          "identity": {
            "properties": {
              "board_type": { "const": "pcb" }
            }
          }
        }
      },
      "then": {
        "properties": {
          "components": {
            "items": {
              "required": ["placement"]
            }
          }
        }
      }
    }
  ],

  "$defs": {

    "component": {
      "type": "object",
      "required": ["refdes", "pins"],
      "properties": {
        "refdes": {
          "type": "string",
          "pattern": "^[A-Z]+[0-9]+$"
        },
        "value": { "type": "string" },
        "footprint": { "type": "string" },
        "description": { "type": "string" },
        "manufacturer_part_number": { "type": "string" },
        "attributes": { "type": "object" },

        "placement": {
          "type": "object",
          "required": ["x", "y", "rotation"],
          "properties": {
            "x": { "type": "number" },
            "y": { "type": "number" },
            "rotation": { "type": "number" },
            "side": {
              "type": "string",
              "enum": ["Top", "Bottom"]
            }
          },
          "additionalProperties": false
        },

        "pins": {
          "type": "array",
          "items": { "$ref": "#/$defs/pin" }
        }
      },
      "additionalProperties": false
    },

    "pin": {
      "type": "object",
      "required": ["pin_number", "net"],
      "properties": {
        "pin_number": { "type": "string" },
        "pin_name": { "type": "string" },
        "net": { "type": "string", "minLength": 1 },
        "electrical_type": {
          "type": "string",
          "enum": [
            "input",
            "output",
            "bidirectional",
            "passive",
            "power_in",
            "power_out",
            "analog",
            "digital"
          ]
        }
      },
      "additionalProperties": false
    },

    "net": {
      "type": "object",
      "required": ["name", "connections"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[A-Za-z0-9_\\-]+$"
        },
        "type": {
          "type": "string",
          "enum": ["signal", "power", "ground", "analog", "digital", "clock"]
        },
        "voltage_domain": { "type": "string" },
        "criticality": {
          "type": "string",
          "enum": ["low", "medium", "high", "safety"]
        },
        "connections": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["refdes", "pin"],
            "properties": {
              "refdes": {
                "type": "string",
                "pattern": "^[A-Z]+[0-9]+$"
              },
              "pin": { "type": "string" }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },

    "port": {
      "type": "object",
      "required": ["name", "net"],
      "properties": {
        "name": { "type": "string" },
        "direction": {
          "type": "string",
          "enum": ["input", "output", "bidirectional"]
        },
        "net": { "type": "string" }
      },
      "additionalProperties": false
    },

    "sheet": {
      "type": "object",
      "required": ["sheet_number", "title"],
      "properties": {
        "sheet_number": { "type": "integer", "minimum": 1 },
        "title": { "type": "string" }
      },
      "additionalProperties": false
    },

    "logical_block": {
      "type": "object",
      "required": ["name", "members"],
      "properties": {
        "name": { "type": "string" },
        "members": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    },

    "test_integration": {
      "type": "object",
      "required": ["test_points"],
      "properties": {
        "coverage_status": {
          "type": "string",
          "enum": ["complete", "partial", "missing"]
        },
        "auto_generated": { "type": "boolean" },
        "test_plan_reference": { "type": "string" },
        "test_points": {
          "type": "array",
          "items": { "$ref": "#/$defs/test_point" }
        }
      },
      "additionalProperties": false
    },

    "test_point": {
      "type": "object",
      "required": ["refdes", "net", "measurement_type"],
      "properties": {
        "refdes": {
          "type": "string",
          "pattern": "^[A-Z]+[0-9]+$"
        },
        "net": { "type": "string" },
        "measurement_type": {
          "type": "string",
          "enum": [
            "voltage",
            "current",
            "resistance",
            "continuity",
            "frequency",
            "logic_level",
            "custom"
          ]
        },
        "expected_range": {
          "type": "object",
          "required": ["min", "max"],
          "properties": {
            "min": { "type": "number" },
            "max": { "type": "number" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },

    "analysis": {
      "type": "object",
      "properties": {
        "component_count": { "type": "integer" },
        "net_count": { "type": "integer" },
        "floating_nets": {
          "type": "array",
          "items": { "type": "string" }
        },
        "unconnected_pins": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["refdes", "pin"],
            "properties": {
              "refdes": { "type": "string" },
              "pin": { "type": "string" }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    }
  }
}
