<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Website Editor</title>
  <style>
    :root{
      --bg: #0f141b;
      --bg-soft: #141b24;
      --panel: #1b2430;
      --panel-2: #202b3a;
      --text: #e6edf3;
      --muted: #a6b4c3;
      --accent: #7bdcb5;
      --accent-2: #66a3ff;
      --danger: #ff7b7b;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 14px;
      --mono: "Cascadia Mono", "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      --sans: "Space Grotesk", "Trebuchet MS", "Segoe UI", sans-serif;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(102,163,255,0.25), transparent 60%),
        radial-gradient(1000px 600px at 90% 10%, rgba(123,220,181,0.2), transparent 65%),
        var(--bg);
    }

    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:22px 28px 16px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(8px);
      background: rgba(15,20,27,0.75);
      position: sticky;
      top:0;
      z-index:10;
    }

    .title{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:22px;
      font-weight:600;
      letter-spacing:0.4px;
    }

    .title .badge{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:1px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .layout{
      flex:1;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px 22px 26px;
      min-height:0;
      overflow:hidden;
    }

    aside{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .layout.with-terminal-pane{
      grid-template-columns: 320px 1fr 320px;
    }

    .sidebar-body{
      display:flex;
      flex-direction:column;
      min-height:0;
      flex:1;
      overflow:hidden;
    }

    .dock-left .file-list{
      flex: 1 1 auto;
      max-height: 50%;
    }

    .dock-left .terminal{
      flex: 1 1 auto;
      max-height: 50%;
    }

    .terminal-pane{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .sidebar-head{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
    }

    .sidebar-head .label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.9px;
      color: var(--muted);
      margin-bottom:8px;
    }

    .search{
      display:flex;
      align-items:center;
      gap:8px;
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
    }

    .search input{
      background: transparent;
      border: none;
      color: var(--text);
      width:100%;
      font-size:14px;
      outline:none;
    }

    .meta-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
    }

    .pill{
      padding:3px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,0.03);
    }

    .file-list{
      overflow:auto;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
      min-height:0;
    }

    .file-item{
      border:1px solid transparent;
      border-radius:12px;
      padding:10px 12px;
      background: rgba(255,255,255,0.02);
      cursor:pointer;
      transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .file-item:hover{
      border-color: rgba(123,220,181,0.4);
      transform: translateY(-1px);
      background: rgba(123,220,181,0.08);
    }

    .file-item.active{
      border-color: rgba(102,163,255,0.8);
      background: rgba(102,163,255,0.15);
      box-shadow: inset 0 0 0 1px rgba(102,163,255,0.35);
    }

    .file-item .name{
      font-weight:600;
      font-size:12px;
      font-family: var(--mono);
      word-break: break-word;
    }

    main{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .preview-head{
      padding:18px 20px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(32,43,58,0.5);
    }

    .preview-title{
      font-size:18px;
      font-weight:600;
    }

    .preview-meta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color: var(--muted);
      font-size:12px;
    }

    .toolbar{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .top-actions{
      position: absolute;
      top: 18px;
      right: 22px;
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 12;
    }

    .command-bar{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:16px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.03);
    }

    .command-bar .input{
      min-width: 220px;
    }

    .terminal{
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(8,12,18,0.65);
      padding:10px;
      min-height:160px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .terminal-log{
      flex:1;
      overflow:auto;
      font-family: var(--mono);
      font-size:12px;
      color: var(--muted);
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .terminal-line{
      display:flex;
      gap:8px;
      white-space:pre-wrap;
    }

    .terminal-line .tag{
      color: var(--accent-2);
    }

    .terminal-input{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .form-tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
    }

    .form-tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      padding:6px 12px;
      border-radius:10px;
      font-size:12px;
      letter-spacing:0.4px;
      text-transform:uppercase;
      cursor:pointer;
      transition: all 0.12s ease;
    }

    .form-tab.active{
      color: var(--text);
      border-color: rgba(102,163,255,0.8);
      background: rgba(102,163,255,0.18);
    }

    .form-panel{
      display:none;
    }

    .form-panel.active{
      display:block;
    }

    .section-tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
    }

    .section-tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      padding:5px 10px;
      border-radius:10px;
      font-size:11px;
      letter-spacing:0.4px;
      text-transform:uppercase;
      cursor:pointer;
      transition: all 0.12s ease;
    }

    .section-tab.active{
      color: var(--text);
      border-color: rgba(102,163,255,0.8);
      background: rgba(102,163,255,0.18);
    }

    .section-tab.visible{
      color: var(--accent);
      border-color: rgba(123,220,181,0.8);
      background: rgba(123,220,181,0.15);
    }

    .section-tab.hidden{
      color: #ffd27b;
      border-color: rgba(255,210,123,0.9);
      background: rgba(255,210,123,0.16);
    }

    .section-group{
      display:none;
    }

    .section-group.active{
      display:block;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding:6px 12px;
      border-radius:10px;
      font-size:12px;
      letter-spacing:0.4px;
      text-transform:uppercase;
      cursor:pointer;
      transition: all 0.12s ease;
    }

    .btn:hover{
      border-color: rgba(102,163,255,0.6);
      background: rgba(102,163,255,0.15);
    }

    .btn.secondary{
      color: var(--muted);
    }

    .btn.save{
      border-color: rgba(123,220,181,0.6);
      color: var(--accent);
    }

    .btn.save.dirty{
      background: rgba(123,220,181,0.18);
      border-color: rgba(123,220,181,0.9);
      color: #dff7ee;
    }

    .preview{
      padding:18px 20px 22px;
      overflow:auto;
      min-height:0;
      flex:1;
    }

    .panel-card{
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.03);
      padding:12px;
      min-height:0;
    }

    .panel-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      color: var(--muted);
      margin-bottom:10px;
    }

    .form-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }

    .form-stack{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .section-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background: rgba(255,255,255,0.02);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .inline-row{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:10px;
    }

    .row-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .tiny{
      font-size:11px;
      color: var(--muted);
    }

    .badge-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .badge-pill{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.6px;
      padding:3px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .help{
      font-size:11px;
      color: var(--muted);
      line-height:1.4;
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color: var(--muted);
    }

    .input, textarea{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font: inherit;
    }

    textarea{
      font-family: var(--mono);
      font-size:12px;
      min-height:300px;
      resize: vertical;
    }

    .panel-actions{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .status{
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .status.ok{ background: rgba(123,220,181,0.12); color: var(--accent); border:1px solid rgba(123,220,181,0.35); }
    .status.warn{ background: rgba(255,205,123,0.12); color: #ffd27b; border:1px solid rgba(255,205,123,0.35); }
    .status.err{ background: rgba(255,123,123,0.12); color: var(--danger); border:1px solid rgba(255,123,123,0.35); }

    .empty{
      color: var(--muted);
      font-size:14px;
      padding:18px;
      border:1px dashed var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.02);
    }

    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
    }

    .modalBack.open{
      display:flex;
    }

    .modal{
      width: min(520px, 96vw);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .modal h3{
      margin: 0 0 12px;
      font-size: 18px;
    }

    .modalGrid{
      display: grid;
      gap: 10px;
    }

    .modalActions{
      margin-top: 14px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .modalSmall{
      width: min(460px, 96vw);
    }

    .context-menu{
      position: fixed;
      z-index: 80;
      display: none;
      min-width: 140px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .context-menu button{
      width: 100%;
      border: none;
      background: transparent;
      color: var(--text);
      text-align: left;
      padding: 8px 10px;
      cursor: pointer;
    }

    .context-menu button:hover{
      background: rgba(102,163,255,0.15);
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      aside{ order:2; }
      main{ order:1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        Website Editor
        <span class="badge">Form + HTML</span>
      </div>
    </header>
    <div class="top-actions">
      <button class="btn save" id="saveBtn" type="button">Save</button>
      <button class="btn secondary" id="prefsBtn" type="button">Preferences</button>
    </div>

    <div class="layout" id="layoutRoot">
      <aside>
        <div class="sidebar-head">
          <div class="label">HTML Files</div>
          <div class="search">
            <input id="searchInput" type="search" placeholder="Filter by filename or title..." />
          </div>
          <div class="meta-row">
            <span class="pill" id="fileCount">Loading...</span>
            <span class="pill" id="dataStatus">Index: pending</span>
          </div>
        </div>
        <div class="sidebar-body">
          <div class="file-list" id="fileList"></div>
          <div id="terminalDockLeft"></div>
        </div>
      </aside>

      <main>
        <div class="preview-head">
          <div class="preview-title" id="previewTitle">Select an HTML file</div>
          <div class="preview-meta" id="previewMeta"></div>
        </div>
        <div class="preview">
          <div class="form-tabs" id="formTabs">
            <button class="form-tab active" data-tab="template" type="button">Template</button>
            <button class="form-tab" data-tab="content" type="button">Content</button>
            <button class="form-tab" data-tab="sections" type="button">Sections</button>
            <button class="form-tab" data-tab="collection" type="button">Collection</button>
            <button class="form-tab" data-tab="assist" type="button">Assist</button>
          </div>
          <div class="form-panel active" id="panel-template"></div>
          <div class="form-panel" id="panel-content"></div>
          <div class="form-panel" id="panel-sections"></div>
          <div class="form-panel" id="panel-collection"></div>
          <div class="form-panel" id="panel-assist">
            <div class="command-bar">
              <span class="badge-pill">Command</span>
              <input class="input" id="commandInput" type="text" placeholder="save | ai ..." />
              <button class="btn secondary" id="commandRunBtn" type="button">Run</button>
              <span class="tiny">Tip: press Enter to run.</span>
            </div>
          </div>
        </div>
      </main>
      <aside class="terminal-pane" id="terminalDockRight" aria-hidden="true"></aside>
    </div>
  </div>

  <div class="terminal" id="terminalPane">
    <div class="terminal-log" id="terminalLog"></div>
    <div class="terminal-input">
      <span class="badge-pill">AI</span>
      <input class="input" id="terminalInput" type="text" placeholder="Ask the editor to draft or update a section..." />
      <button class="btn secondary" id="terminalSendBtn" type="button">Send</button>
    </div>
  </div>

  <div class="modalBack" id="prefsModal">
    <div class="modal">
      <h3>Preferences</h3>
      <div class="modalGrid">
        <label>
          Default directory
          <input class="input" id="baseDirInput" type="text" placeholder="draft/" />
        </label>
        <label>
          Terminal Dock
          <select class="input" id="terminalDockInput">
            <option value="left-bottom">Left Pane (Lower Half)</option>
            <option value="right-pane">Right Pane</option>
          </select>
        </label>
        <div class="empty">
          This path prefixes file loads and preview links. Default is <strong>draft/</strong>.
        </div>
      </div>
      <div class="modalActions">
        <button class="btn secondary" id="prefsCancel" type="button">Cancel</button>
        <button class="btn" id="prefsSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <div class="modalBack" id="sectionModal">
    <div class="modal modalSmall">
      <h3>Edit Section</h3>
      <div class="modalGrid">
        <label>
          Section ID
          <input class="input" id="sectionIdInput" type="text" />
        </label>
        <label>
          Tab Label
          <input class="input" id="sectionTabInput" type="text" />
        </label>
        <label>
          Section Title
          <input class="input" id="sectionTitleInput" type="text" />
        </label>
      </div>
      <div class="modalActions">
        <button class="btn secondary" id="sectionCancel" type="button">Cancel</button>
        <button class="btn" id="sectionSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <div class="context-menu" id="sectionContextMenu">
    <button type="button" id="sectionDeleteBtn">Delete Section</button>
  </div>

  <script src="draft/html_index.js"></script>
  <script>
    const PREFS_KEY = "websiteEditorBaseDir";
    const TEMPLATE_KEY = "websiteEditorTemplate";
    const TERMINAL_DOCK_KEY = "websiteEditorTerminalDock";
    const LOCAL_PREFIX = "websiteEditorDraft::";
    const SAVE_DELAY = 600;

    const state = {
      entries: [],
      filtered: [],
      current: null,
      originalText: "",
      editorText: "",
      saveTimer: null,
      baseDir: "draft/",
      formState: null,
      template: null,
      editingSectionCard: null
    };

    let contextTargetTab = null;

    const $ = (id) => document.getElementById(id);

    function escapeHtml(str){
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    const defaultTemplate = () => {
      const scriptClose = "</" + "script>";
      return ({
        analyticsHtml:
`<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9ZM2D6XGT2">${scriptClose}
<script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9ZM2D6XGT2');
    ${scriptClose}`,
      defaultKeywords: "",
      defaultDescription: "",
      footerText: "© 2026 miniPCB. All rights reserved.",
      cssHrefBoard: "/styles.css",
      cssHrefCollection: "../styles.css",
      jsHrefBoard: "/js/minipcb.js",
      faviconHref: "/favicon.png",
      versionStamp: "v2",
      dateStamp: "2026-02-04"
      });
    };

    function loadTemplate(){
      try{
        const raw = localStorage.getItem(TEMPLATE_KEY);
        if(raw){
          return { ...defaultTemplate(), ...JSON.parse(raw) };
        }
      }catch(_){}
      return defaultTemplate();
    }

    function saveTemplate(next){
      state.template = { ...state.template, ...next };
      localStorage.setItem(TEMPLATE_KEY, JSON.stringify(state.template));
    }

    function getTerminalDock(){
      return localStorage.getItem(TERMINAL_DOCK_KEY) || "left-bottom";
    }

    function setTerminalDock(mode){
      localStorage.setItem(TERMINAL_DOCK_KEY, mode);
      applyTerminalDock(mode);
    }

    function applyTerminalDock(mode){
      const layout = $("layoutRoot");
      const leftDock = $("terminalDockLeft");
      const rightDock = $("terminalDockRight");
      const terminal = $("terminalPane");
      if(!layout || !leftDock || !rightDock || !terminal) return;

      if(mode === "right-pane"){
        layout.classList.add("with-terminal-pane");
        document.body.classList.remove("dock-left");
        rightDock.setAttribute("aria-hidden", "false");
        rightDock.appendChild(terminal);
      }else{
        layout.classList.remove("with-terminal-pane");
        document.body.classList.add("dock-left");
        rightDock.setAttribute("aria-hidden", "true");
        leftDock.appendChild(terminal);
      }
    }

    function setStatus(kind, message){
      const el = $("editStatus");
      if(!el) return;
      el.textContent = message;
      el.className = "status " + kind;
    }

    function setSaveDirty(isDirty){
      const btn = $("saveBtn");
      if(!btn) return;
      btn.classList.toggle("dirty", !!isDirty);
    }

    function setDataStatus(ok, message){
      const el = $("dataStatus");
      el.textContent = message;
      el.className = ok ? "pill status ok" : "pill status err";
    }

    function logTerminal(kind, message){
      const log = $("terminalLog");
      if(!log) return;
      const line = document.createElement("div");
      line.className = "terminal-line";
      const stamp = new Date().toLocaleTimeString();
      line.innerHTML = `<span class="tag">[${escapeHtml(kind)}]</span><span>${escapeHtml(stamp)} ${escapeHtml(message)}</span>`;
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    function normalizeBaseDir(value){
      const trimmed = String(value || "").trim();
      if(!trimmed) return "";
      return trimmed.endsWith("/") ? trimmed : trimmed + "/";
    }

    function getBaseDir(){
      const stored = localStorage.getItem(PREFS_KEY);
      return normalizeBaseDir(stored || state.baseDir);
    }

    function setBaseDir(next){
      const normalized = normalizeBaseDir(next);
      state.baseDir = normalized || "draft/";
      localStorage.setItem(PREFS_KEY, state.baseDir);
    }

    function loadDraft(path){
      return localStorage.getItem(LOCAL_PREFIX + path);
    }

    function saveDraft(path, text){
      localStorage.setItem(LOCAL_PREFIX + path, text);
    }

    function clearDraft(path){
      localStorage.removeItem(LOCAL_PREFIX + path);
    }

    function listFromIndex(baseDir){
      const src = Array.isArray(window.DRAFT_HTML_INDEX) ? window.DRAFT_HTML_INDEX : [];
      return src
        .filter(path => typeof path === "string" && path.toLowerCase().endsWith(".html"))
        .map(path => {
          const rel = path.replace(/^\.\//, "");
          return {
            rel,
            url: rel,
            path: baseDir + rel,
            title: rel
          };
        })
        .sort((a, b) => a.rel.localeCompare(b.rel));
    }

    async function ensureIndexLoaded(){
      if(Array.isArray(window.DRAFT_HTML_INDEX) && window.DRAFT_HTML_INDEX.length) return true;
      const candidate = `${state.baseDir}html_index.js`;
      try{
        const res = await fetch(candidate, { cache: "no-store" });
        if(!res.ok) throw new Error(`Failed to fetch ${candidate}`);
        const text = await res.text();
        const loader = new Function(text + "\nreturn window.DRAFT_HTML_INDEX;");
        const list = loader();
        if(Array.isArray(list) && list.length){
          return true;
        }
      }catch(err){
        logTerminal("error", err?.message || "Failed to load html_index.js");
      }
      return false;
    }

    function renderList(){
      const list = $("fileList");
      list.innerHTML = "";
      if(!state.filtered.length){
        list.innerHTML = '<div class="empty">No files match the filter.</div>';
        return;
      }

      state.filtered.forEach(entry => {
        const item = document.createElement("div");
        item.className = "file-item" + (state.current && state.current.url === entry.url ? " active" : "");
        item.innerHTML = `<div class="name">${escapeHtml(entry.rel || entry.path)}</div>`;
        item.addEventListener("click", () => selectEntry(entry));
        list.appendChild(item);
      });
    }

    function filterList(query){
      const q = query.trim().toLowerCase();
      if(!q){
        state.filtered = state.entries.slice();
      }else{
        state.filtered = state.entries.filter(e => {
          return (e.rel || "").toLowerCase().includes(q);
        });
      }
      $("fileCount").textContent = `${state.filtered.length} files`;
      renderList();
    }

    function updatePreviewMeta(entry){
      const meta = $("previewMeta");
      if(!entry){
        meta.innerHTML = "";
        return;
      }
      const parts = [
        `<span class="pill">${escapeHtml(entry.path)}</span>`
      ];
      meta.innerHTML = parts.join("");
    }

    function generateBoardHtml(formData, template){
      const tpl = template || defaultTemplate();
      const scriptClose = "</" + "script>";
      const nav = formData.nav.map(item => `  <li><a href="${escapeHtml(item.href)}">${escapeHtml(item.text)}</a></li>`).join("\n");
      const tabs = formData.sections.filter(section => section.tabLabel);
      const firstTabId = tabs.length ? tabs[0].id : (formData.sections[0] ? formData.sections[0].id : "");
      const tabButtons = tabs.map(section => {
        const active = section.id === firstTabId ? " active" : "";
        const selected = section.id === firstTabId ? "true" : "false";
        return `  <button aria-controls="${escapeHtml(section.id)}" aria-selected="${selected}" class="tab${active}" data-tab="${escapeHtml(section.id)}" role="tab" type="button">${escapeHtml(section.tabLabel)}</button>`;
      }).join("\n");

      const sectionsHtml = formData.sections.map(section => {
        const active = section.id === firstTabId ? " active" : "";
        const hiddenAttr = section.hidden ? ' data-hidden="true"' : "";
        if(section.type === "details"){
          const rows = (section.rows || [])
            .map(row => `<p><strong>${escapeHtml(row.label)}:</strong> ${escapeHtml(row.value)}</p>`)
            .join("\n");
          return `<div aria-hidden="${section.id === firstTabId ? "false" : "true"}" class="tab-content${active}"${hiddenAttr} id="${escapeHtml(section.id)}">\n<h2>${escapeHtml(section.title)}</h2>\n${rows}\n</div>`;
        }
        if(section.type === "images"){
          const images = (section.images || []).map(img => {
            const full = img.full ? ` data-full="${escapeHtml(img.full)}"` : "";
            return `<img alt="${escapeHtml(img.alt)}" class="zoomable" loading="lazy" src="${escapeHtml(img.src)}"${full} onclick="openLightbox(this)"/>`;
          }).join("\n");
          return `<div aria-hidden="${section.id === firstTabId ? "false" : "true"}" class="tab-content${active}"${hiddenAttr} id="${escapeHtml(section.id)}">\n<h2>${escapeHtml(section.title)}</h2>\n<div class="lightbox-container">\n${images}\n</div>\n</div>`;
        }
        if(section.type === "downloads"){
          const items = (section.items || []).map(item => {
            return `  <li><a href="${escapeHtml(item.href)}" rel="noopener noreferrer" target="_blank">${escapeHtml(item.label)}</a></li>`;
          }).join("\n");
          return `<div aria-hidden="${section.id === firstTabId ? "false" : "true"}" class="tab-content${active}"${hiddenAttr} id="${escapeHtml(section.id)}">\n<h2>${escapeHtml(section.title)}</h2>\n<ul class="download-list">\n${items}\n</ul>\n</div>`;
        }
        if(section.type === "videos"){
          const items = (section.videos || []).map(video => {
            return `<div class="video-wrapper">
    <iframe src="${escapeHtml(video.src)}" title="${escapeHtml(video.title || "YouTube video player")}" width="${escapeHtml(video.width || "560")}" height="${escapeHtml(video.height || "315")}" loading="lazy" referrerpolicy="strict-origin-when-cross-origin" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen frameborder="0"></iframe>
  </div>`;
          }).join("\n");
          return `<div aria-hidden="${section.id === firstTabId ? "false" : "true"}" class="tab-content${active}"${hiddenAttr} id="${escapeHtml(section.id)}">\n<h2>${escapeHtml(section.title)}</h2>\n${items}\n</div>`;
        }
        if(section.type === "revisions"){
          const rows = (section.rows || []).map(row => {
            return `<tr>
<td>${escapeHtml(row.date)}</td>
<td>${escapeHtml(row.rev)}</td>
<td>${escapeHtml(row.desc)}</td>
<td>${escapeHtml(row.by)}</td>
</tr>`;
          }).join("\n");
          return `<div aria-hidden="${section.id === firstTabId ? "false" : "true"}" class="tab-content${active}"${hiddenAttr} id="${escapeHtml(section.id)}">\n<h2>${escapeHtml(section.title)}</h2>\n<table class="revisions-table"><thead><tr><th>Date</th><th>Revision</th><th>Description</th><th>By</th></tr></thead><tbody>\n${rows}\n</tbody></table>\n</div>`;
        }
        if(section.type === "ai-seeds"){
          const jsonText = section.jsonText || "{}";
          return `<div aria-hidden="true" class="tab-content" data-hidden="true" id="${escapeHtml(section.id)}">\n<script id="ai-seeds-json" type="application/json">${jsonText}${scriptClose}\n</div>`;
        }
        const body = section.bodyHtml || "";
        return `<div aria-hidden="${section.id === firstTabId ? "false" : "true"}" class="tab-content${active}"${hiddenAttr} id="${escapeHtml(section.id)}">\n<h2>${escapeHtml(section.title)}</h2>\n${body}\n</div>`;
      }).join("\n\n");

      const keywords = formData.meta.keywords || tpl.defaultKeywords || "";
      const description = formData.meta.description || tpl.defaultDescription || "";
      const headStamp = tpl.versionStamp || tpl.dateStamp ? `<!-- Generated: ${escapeHtml(tpl.dateStamp || "")} | Version: ${escapeHtml(tpl.versionStamp || "")} -->` : "";
      const analytics = tpl.analyticsHtml ? tpl.analyticsHtml + "\n" : "";
      const cssHref = tpl.cssHrefBoard || "/styles.css";
      const jsHref = tpl.jsHrefBoard || "";
      const faviconHref = tpl.faviconHref || "/favicon.png";
      const footerText = tpl.footerText || "© 2026 miniPCB. All rights reserved.";

      return `<!DOCTYPE html>
<html lang="en">
<head>
${analytics}${headStamp}
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>${escapeHtml(formData.meta.title || "")}</title>
<link href="${escapeHtml(cssHref)}" rel="stylesheet"/>
<link href="${escapeHtml(faviconHref)}" rel="icon" type="image/png"/>
<meta content="${escapeHtml(keywords)}" name="keywords"/>
<meta content="${escapeHtml(description)}" name="description"/>
</head>
<body>
<nav>
<div class="nav-container">
<ul class="nav-links">
${nav}
</ul>
</div>
</nav>
<header>
<h1>${escapeHtml(formData.meta.h1 || "")}</h1>
<p class="slogan">${escapeHtml(formData.meta.slogan || "")}</p>
</header>
<main>
<div class="tab-container">
<div aria-label="Sections" class="tabs" role="tablist">
${tabButtons}
</div>

${sectionsHtml}
</div>
</main>
<footer>
      ${escapeHtml(footerText)}
    </footer>
<div aria-hidden="true" aria-label="Image viewer" id="lightbox" role="dialog">
<img alt="Expanded image" id="lightbox-img"/>
</div>
${jsHref ? `<script src="${escapeHtml(jsHref)}">${scriptClose}` : ""}
</body>
</html>`;
    }

    function generateCollectionHtml(formData, template){
      const tpl = template || defaultTemplate();
      const nav = formData.nav.map(item => `  <li><a href="${escapeHtml(item.href)}">${escapeHtml(item.text)}</a></li>`).join("\n");
      const rows = (formData.rows || []).map(row => {
        return `<tr>
<td>${escapeHtml(row.partNo || "")}</td>
<td><a href="${escapeHtml(row.href || "")}">${escapeHtml(row.title || "")}</a></td>
<td>${escapeHtml(row.pieces || "")}</td>
</tr>`;
      }).join("\n");

      const keywords = formData.meta.keywords || tpl.defaultKeywords || "";
      const headStamp = tpl.versionStamp || tpl.dateStamp ? `<!-- Generated: ${escapeHtml(tpl.dateStamp || "")} | Version: ${escapeHtml(tpl.versionStamp || "")} -->` : "";
      const analytics = tpl.analyticsHtml ? tpl.analyticsHtml + "\n" : "";
      const cssHref = tpl.cssHrefCollection || "../styles.css";
      const faviconHref = tpl.faviconHref || "/favicon.png";
      const footerText = tpl.footerText || "© 2026 miniPCB. All rights reserved.";

      return `<!DOCTYPE html>
<html lang="en">
<head>
${analytics}${headStamp}
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>${escapeHtml(formData.meta.title || "")}</title>
<link href="${escapeHtml(cssHref)}" rel="stylesheet"/>
<link href="${escapeHtml(faviconHref)}" rel="icon" type="image/png"/>
<meta content="${escapeHtml(keywords)}" name="keywords"/>
</head>
<body>
<nav>
<div class="nav-container">
<ul class="nav-links">
${nav}
</ul>
</div>
</nav>
<header>
<h1>${escapeHtml(formData.meta.h1 || "")}</h1>
</header>
<main>
<section>
<table>
<thead>
<tr>
<th>Part No</th>
<th>Title</th>
<th>Pieces per Panel</th>
</tr>
</thead>
<tbody>
${rows}
</tbody>
</table>
</section>
</main>
<footer>
   ${escapeHtml(footerText)}
  </footer>
</body>
</html>`;
    }

    function extractBoardFromHtml(doc){
      const metaDesc = doc.querySelector('meta[name="description"]');
      const metaKeywords = doc.querySelector('meta[name="keywords"]');
      const h1 = doc.querySelector("header h1") || doc.querySelector("h1");
      const slogan = doc.querySelector("header .slogan") || doc.querySelector(".slogan");

      const navLinks = Array.from(doc.querySelectorAll(".nav-links a")).map(link => ({
        text: link.textContent.trim(),
        href: link.getAttribute("href") || ""
      }));

      const tabs = Array.from(doc.querySelectorAll(".tabs .tab")).map(btn => {
        const onclick = btn.getAttribute("onclick") || "";
        const match = onclick.match(/showTab\('([^']+)'/);
        return {
          id: match ? match[1] : btn.dataset.tab || "",
          label: btn.textContent.trim()
        };
      });
      const tabById = new Map(tabs.map(tab => [tab.id, tab.label]));

      const sections = Array.from(doc.querySelectorAll(".tab-content")).map((section, idx) => {
        const id = section.id || `section-${idx + 1}`;
        const hidden = section.getAttribute("data-hidden") === "true";
        const h2 = section.querySelector("h2");
        const title = h2 ? h2.textContent.trim() : id;
        const tabLabel = tabById.get(id) || "";
        if(id === "details"){
          const rows = Array.from(section.querySelectorAll("p")).map(p => {
            const strong = p.querySelector("strong");
            if(!strong) return null;
            const label = strong.textContent.replace(/:$/, "").trim();
            const value = p.textContent.replace(strong.textContent, "").trim();
            return { label, value };
          }).filter(Boolean);
          return { id, hidden, title, tabLabel, type: "details", rows };
        }

        if(id === "downloads" || section.querySelector(".download-list")){
          const items = Array.from(section.querySelectorAll(".download-list a")).map(link => ({
            label: link.textContent.trim(),
            href: link.getAttribute("href") || ""
          }));
          return { id, hidden, title, tabLabel, type: "downloads", items };
        }

        if(id === "revisions" || section.querySelector(".revisions-table")){
          const rows = Array.from(section.querySelectorAll("tbody tr")).map(row => {
            const cells = row.querySelectorAll("td");
            return {
              date: cells[0] ? cells[0].textContent.trim() : "",
              rev: cells[1] ? cells[1].textContent.trim() : "",
              desc: cells[2] ? cells[2].textContent.trim() : "",
              by: cells[3] ? cells[3].textContent.trim() : ""
            };
          });
          return { id, hidden, title, tabLabel, type: "revisions", rows };
        }

        if(id === "ai-seeds" || section.querySelector("#ai-seeds-json")){
          const script = section.querySelector("#ai-seeds-json");
          const text = script ? script.textContent.trim() : "{}";
          return { id, hidden, title, tabLabel, type: "ai-seeds", jsonText: text || "{}" };
        }

        const videos = Array.from(section.querySelectorAll("iframe"));
        if(id === "videos" || videos.length){
          return {
            id,
            hidden,
            title,
            tabLabel,
            type: "videos",
            videos: videos.map(frame => ({
              src: frame.getAttribute("src") || "",
              title: frame.getAttribute("title") || "",
              width: frame.getAttribute("width") || "560",
              height: frame.getAttribute("height") || "315"
            }))
          };
        }

        const images = Array.from(section.querySelectorAll("img"));
        if(images.length){
          return {
            id,
            hidden,
            title,
            tabLabel,
            type: "images",
            images: images.map(img => ({
              src: img.getAttribute("src") || "",
              alt: img.getAttribute("alt") || "",
              full: img.getAttribute("data-full") || ""
            }))
          };
        }

        const clone = section.cloneNode(true);
        const cloneH2 = clone.querySelector("h2");
        if(cloneH2) cloneH2.remove();
        return {
          id,
          hidden,
          title,
          tabLabel,
          type: "html",
          bodyHtml: clone.innerHTML.trim()
        };
      });

      return {
        type: "board",
        meta: {
          title: doc.title || "",
          description: metaDesc ? metaDesc.getAttribute("content") || "" : "",
          keywords: metaKeywords ? metaKeywords.getAttribute("content") || "" : "",
          h1: h1 ? h1.textContent.trim() : "",
          slogan: slogan ? slogan.textContent.trim() : ""
        },
        nav: navLinks,
        sections
      };
    }

    function extractCollectionFromHtml(doc){
      const metaKeywords = doc.querySelector('meta[name="keywords"]');
      const h1 = doc.querySelector("header h1") || doc.querySelector("h1");
      const navLinks = Array.from(doc.querySelectorAll(".nav-links a")).map(link => ({
        text: link.textContent.trim(),
        href: link.getAttribute("href") || ""
      }));

      const rows = Array.from(doc.querySelectorAll("tbody tr")).map(row => {
        const cells = row.querySelectorAll("td");
        const partNo = cells[0] ? cells[0].textContent.trim() : "";
        const titleLink = cells[1] ? cells[1].querySelector("a") : null;
        const title = titleLink ? titleLink.textContent.trim() : (cells[1] ? cells[1].textContent.trim() : "");
        const href = titleLink ? titleLink.getAttribute("href") || "" : "";
        const pieces = cells[2] ? cells[2].textContent.trim() : "";
        return { partNo, title, href, pieces };
      });

      return {
        type: "collection",
        meta: {
          title: doc.title || "",
          description: "",
          keywords: metaKeywords ? metaKeywords.getAttribute("content") || "" : "",
          h1: h1 ? h1.textContent.trim() : "",
          slogan: ""
        },
        nav: navLinks,
        rows
      };
    }

    function extractFormFromHtml(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const isBoard = !!doc.querySelector(".tab-container .tab-content");
      if(isBoard){
        return extractBoardFromHtml(doc);
      }
      return extractCollectionFromHtml(doc);
    }

    function extractTemplateFromHtml(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const headScripts = Array.from(doc.querySelectorAll("head script"));
      const analyticsScripts = headScripts.filter(script => {
        const src = script.getAttribute("src") || "";
        const text = script.textContent || "";
        return src.includes("googletagmanager.com/gtag/js") || text.includes("gtag('config'");
      });
      const analyticsHtml = analyticsScripts.map(s => s.outerHTML).join("\n");

      const stylesheet = doc.querySelector('link[rel="stylesheet"]');
      const cssHref = stylesheet ? stylesheet.getAttribute("href") || "" : "";
      const favicon = doc.querySelector('link[rel="icon"]');
      const faviconHref = favicon ? favicon.getAttribute("href") || "" : "";

      const scripts = Array.from(doc.querySelectorAll("script[src]"));
      const jsHref = scripts.length ? scripts[scripts.length - 1].getAttribute("src") || "" : "";

      const footer = doc.querySelector("footer");
      const footerText = footer ? footer.textContent.trim().replace(/\s+/g, " ") : "";

      const next = { ...defaultTemplate() };
      if(analyticsHtml) next.analyticsHtml = analyticsHtml;
      if(cssHref){
        if(cssHref.startsWith("../")) next.cssHrefCollection = cssHref;
        else next.cssHrefBoard = cssHref;
      }
      if(faviconHref) next.faviconHref = faviconHref;
      if(jsHref) next.jsHrefBoard = jsHref;
      if(footerText) next.footerText = footerText;
      return next;
    }

    function syncFormInputs(html){
      state.formState = extractFormFromHtml(html);
      renderForm(state.formState);
    }

    function renderForm(data){
      const panelTemplate = $("panel-template");
      const panelContent = $("panel-content");
      const panelSections = $("panel-sections");
      const panelCollection = $("panel-collection");
      const panelAssist = $("panel-assist");
      [panelTemplate, panelContent, panelSections, panelCollection, panelAssist].forEach(panel => {
        if(panel) panel.innerHTML = "";
      });

      const templateCard = document.createElement("div");
      templateCard.className = "panel-card";
      templateCard.innerHTML = `
        <div class="panel-title">Template Editor</div>
        <div class="help">Global defaults and includes used when Update generates full HTML.</div>
        <div class="form-grid">
          <label>Analytics HTML
            <textarea class="input" data-field="tpl-analytics" placeholder="Paste analytics script(s)..."></textarea>
          </label>
          <label>Default Keywords
            <input class="input" data-field="tpl-default-keywords" type="text" placeholder="Default keywords" />
          </label>
          <label>Default Description
            <input class="input" data-field="tpl-default-description" type="text" placeholder="Default description" />
          </label>
          <label>Footer Text
            <input class="input" data-field="tpl-footer" type="text" placeholder="© 2026 miniPCB. All rights reserved." />
          </label>
          <label>Stylesheet (Board)
            <input class="input" data-field="tpl-css-board" type="text" placeholder="/styles.css" />
          </label>
          <label>Stylesheet (Collection)
            <input class="input" data-field="tpl-css-collection" type="text" placeholder="../styles.css" />
          </label>
          <label>Script (Board)
            <input class="input" data-field="tpl-js-board" type="text" placeholder="/js/minipcb.js" />
          </label>
          <label>Favicon Href
            <input class="input" data-field="tpl-favicon" type="text" placeholder="/favicon.png" />
          </label>
          <label>Version Stamp
            <input class="input" data-field="tpl-version" type="text" placeholder="v2" />
          </label>
          <label>Date Stamp
            <input class="input" data-field="tpl-date" type="text" placeholder="2026-02-04" />
          </label>
        </div>
        <div class="row-actions">
          <button class="btn secondary" data-action="tpl-load" type="button">Load From File</button>
          <button class="btn" data-action="tpl-save" type="button">Save Template</button>
        </div>
      `;
      panelTemplate.appendChild(templateCard);

      const metaCard = document.createElement("div");
      metaCard.className = "panel-card";
      metaCard.innerHTML = `
        <div class="panel-title">Page Meta</div>
        <div class="badge-row">
          <span class="badge-pill">${escapeHtml(data.type || "unknown")}</span>
        </div>
        <div class="form-grid">
          <label>Title<input class="input" data-field="meta-title" type="text"></label>
          <label>Meta Keywords<input class="input" data-field="meta-keywords" type="text"></label>
          <label>Header H1<input class="input" data-field="meta-h1" type="text"></label>
          <label>Meta Description<input class="input" data-field="meta-description" type="text"></label>
          <label>Slogan<input class="input" data-field="meta-slogan" type="text"></label>
        </div>
      `;
      panelContent.appendChild(metaCard);

      const navCard = document.createElement("div");
      navCard.className = "panel-card";
      navCard.innerHTML = `
        <div class="panel-title">Navigation Links</div>
        <div class="form-stack" data-nav-list></div>
        <div class="row-actions">
          <button class="btn secondary" data-action="add-nav" type="button">Add Link</button>
        </div>
      `;
      panelContent.appendChild(navCard);

      const aiCard = document.createElement("div");
      aiCard.className = "panel-card";
      aiCard.innerHTML = `
        <div class="panel-title">AI Assist</div>
        <div class="help">Local helper only — no external AI API wired yet. Use this to draft text or paste a list to populate rows.</div>
        <div class="form-grid">
          <label>Target Section
            <select class="input" data-field="ai-target"></select>
          </label>
          <label>Paste Draft / List
            <textarea class="input" data-field="ai-input" placeholder="Paste notes or CSV: PartNo, Title, Href, Pieces"></textarea>
          </label>
        </div>
        <div class="row-actions">
          <button class="btn" data-action="ai-draft" type="button">Draft Section Text</button>
          <button class="btn secondary" data-action="ai-rows" type="button">Populate Rows</button>
        </div>
      `;
      panelAssist.appendChild(aiCard);

      if(data.type === "board"){
        const sectionsWrap = document.createElement("div");
        sectionsWrap.className = "panel-card";
        sectionsWrap.innerHTML = `
          <div class="panel-title">Sections</div>
          <div class="section-tabs" id="sectionTabs"></div>
        `;
        panelSections.appendChild(sectionsWrap);

        const sectionsStack = document.createElement("div");
        sectionsStack.className = "form-stack";
        sectionsWrap.appendChild(sectionsStack);

        const tabsRow = sectionsWrap.querySelector("#sectionTabs");
        const groups = new Map();

        const hasDescription = (data.sections || []).some(section => section.id === "description");
        if(!hasDescription){
          data.sections = (data.sections || []).concat([{
            id: "description",
            title: "Description",
            tabLabel: "Description",
            hidden: false,
            type: "html",
            bodyHtml: "<p>Describe this board.</p>"
          }]);
        }

        (data.sections || []).forEach((section, idx) => {
          const tabLabel = section.tabLabel || section.title || section.id;
          const tabBtn = document.createElement("button");
          tabBtn.className = "section-tab" + (idx === 0 ? " active" : "");
          tabBtn.type = "button";
          tabBtn.dataset.subtab = section.id;
          tabBtn.textContent = tabLabel;
          tabsRow.appendChild(tabBtn);

          const group = document.createElement("div");
          group.className = "section-group" + (idx === 0 ? " active" : "");
          group.dataset.subtab = section.id;
          group.dataset.visible = section.hidden ? "false" : "true";
          sectionsStack.appendChild(group);
          groups.set(section.id, group);

          const card = document.createElement("div");
          card.className = "section-card";
          card.dataset.sectionId = section.id;
          card.dataset.sectionType = section.type;
          card.dataset.sectionTitle = section.title || "";
          card.dataset.sectionTab = section.tabLabel || "";
          card.innerHTML = `
            <div class="badge-row">
              <span class="badge-pill">${escapeHtml(section.id)}</span>
              ${section.tabLabel ? `<span class="badge-pill">${escapeHtml(section.tabLabel)}</span>` : ""}
              ${section.title ? `<span class="badge-pill">${escapeHtml(section.title)}</span>` : ""}
            </div>
          `;

          if(section.type === "details"){
            const rows = document.createElement("div");
            rows.className = "form-stack";
            rows.dataset.detailList = "true";
            (section.rows || []).forEach(row => {
              const rowEl = document.createElement("div");
              rowEl.className = "inline-row";
              rowEl.dataset.detailRow = "true";
              rowEl.innerHTML = `
                <label>Label<input class="input" data-field="detail-label" type="text" value="${escapeHtml(row.label)}"></label>
                <label>Value<input class="input" data-field="detail-value" type="text" value="${escapeHtml(row.value)}"></label>
              `;
              rows.appendChild(rowEl);
            });
            card.appendChild(rows);
            const actions = document.createElement("div");
            actions.className = "row-actions";
            actions.innerHTML = `
              <button class="btn secondary" data-action="add-detail" type="button">Add Detail Row</button>
            `;
            card.appendChild(actions);
          }else if(section.type === "images"){
            const rows = document.createElement("div");
            rows.className = "form-stack";
            rows.dataset.imageList = "true";
            (section.images || []).forEach(img => {
              const rowEl = document.createElement("div");
              rowEl.className = "inline-row";
              rowEl.dataset.imageRow = "true";
              rowEl.innerHTML = `
                <label>Image Src<input class="input" data-field="image-src" type="text" value="${escapeHtml(img.src)}"></label>
                <label>Alt Text<input class="input" data-field="image-alt" type="text" value="${escapeHtml(img.alt)}"></label>
                <label>Full Src<input class="input" data-field="image-full" type="text" value="${escapeHtml(img.full || "")}"></label>
              `;
              rows.appendChild(rowEl);
            });
            card.appendChild(rows);
            const actions = document.createElement("div");
            actions.className = "row-actions";
            actions.innerHTML = `
              <button class="btn secondary" data-action="add-image" type="button">Add Image</button>
            `;
            card.appendChild(actions);
          }else if(section.type === "downloads"){
            const rows = document.createElement("div");
            rows.className = "form-stack";
            rows.dataset.downloadList = "true";
            (section.items || []).forEach(item => {
              const rowEl = document.createElement("div");
              rowEl.className = "inline-row";
              rowEl.dataset.downloadRow = "true";
              rowEl.innerHTML = `
                <label>Label<input class="input" data-field="download-label" type="text" value="${escapeHtml(item.label || "")}"></label>
                <label>Href<input class="input" data-field="download-href" type="text" value="${escapeHtml(item.href || "")}"></label>
              `;
              rows.appendChild(rowEl);
            });
            card.appendChild(rows);
            const actions = document.createElement("div");
            actions.className = "row-actions";
            actions.innerHTML = `
              <button class="btn secondary" data-action="add-download" type="button">Add Download</button>
            `;
            card.appendChild(actions);
          }else if(section.type === "videos"){
            const rows = document.createElement("div");
            rows.className = "form-stack";
            rows.dataset.videoList = "true";
            (section.videos || []).forEach(video => {
              const rowEl = document.createElement("div");
              rowEl.className = "inline-row";
              rowEl.dataset.videoRow = "true";
              rowEl.innerHTML = `
                <label>Video URL<input class="input" data-field="video-src" type="text" value="${escapeHtml(video.src || "")}"></label>
                <label>Title<input class="input" data-field="video-title" type="text" value="${escapeHtml(video.title || "")}"></label>
                <label>Width<input class="input" data-field="video-width" type="text" value="${escapeHtml(video.width || "")}"></label>
                <label>Height<input class="input" data-field="video-height" type="text" value="${escapeHtml(video.height || "")}"></label>
              `;
              rows.appendChild(rowEl);
            });
            card.appendChild(rows);
            const actions = document.createElement("div");
            actions.className = "row-actions";
            actions.innerHTML = `
              <button class="btn secondary" data-action="add-video" type="button">Add Video</button>
            `;
            card.appendChild(actions);
          }else if(section.type === "revisions"){
            const rows = document.createElement("div");
            rows.className = "form-stack";
            rows.dataset.revisionList = "true";
            (section.rows || []).forEach(row => {
              const rowEl = document.createElement("div");
              rowEl.className = "inline-row";
              rowEl.dataset.revisionRow = "true";
              rowEl.innerHTML = `
                <label>Date<input class="input" data-field="rev-date" type="text" value="${escapeHtml(row.date || "")}"></label>
                <label>Revision<input class="input" data-field="rev-id" type="text" value="${escapeHtml(row.rev || "")}"></label>
                <label>Description<input class="input" data-field="rev-desc" type="text" value="${escapeHtml(row.desc || "")}"></label>
                <label>By<input class="input" data-field="rev-by" type="text" value="${escapeHtml(row.by || "")}"></label>
              `;
              rows.appendChild(rowEl);
            });
            card.appendChild(rows);
            const actions = document.createElement("div");
            actions.className = "row-actions";
            actions.innerHTML = `
              <button class="btn secondary" data-action="add-revision" type="button">Add Revision</button>
            `;
            card.appendChild(actions);
          }else if(section.type === "ai-seeds"){
            const label = document.createElement("label");
            label.innerHTML = `AI Seeds JSON<textarea class="input" data-field="ai-seeds">${escapeHtml(section.jsonText || "{}")}</textarea>`;
            card.appendChild(label);
          }else{
            const label = document.createElement("label");
            label.innerHTML = `Body HTML<textarea class="input" data-field="section-body">${escapeHtml(section.bodyHtml || "")}</textarea>`;
            card.appendChild(label);
          }

          group.appendChild(card);
        });

        const addBtn = document.createElement("button");
        addBtn.className = "section-tab";
        addBtn.type = "button";
        addBtn.dataset.subtab = "add-new";
        addBtn.textContent = "Add New";
        tabsRow.appendChild(addBtn);

        tabsRow.querySelectorAll(".section-tab").forEach(btn => {
          const key = btn.getAttribute("data-subtab");
          if(key === "add-new") return;
          const isVisible = groups.get(key)?.dataset.visible !== "false";
          btn.classList.toggle("visible", isVisible);
          btn.classList.toggle("hidden", !isVisible);
        });
      }else if(data.type === "collection"){
        const rowsWrap = document.createElement("div");
        rowsWrap.className = "panel-card";
        rowsWrap.innerHTML = `<div class="panel-title">Collection Table</div>`;
        const rowsStack = document.createElement("div");
        rowsStack.className = "form-stack";
        rowsStack.dataset.collectionList = "true";
        rowsWrap.appendChild(rowsStack);

        (data.rows || []).forEach(row => {
          const rowEl = document.createElement("div");
          rowEl.className = "inline-row";
          rowEl.dataset.collectionRow = "true";
          rowEl.innerHTML = `
            <label>Part No<input class="input" data-field="row-part" type="text" value="${escapeHtml(row.partNo || "")}"></label>
            <label>Title<input class="input" data-field="row-title" type="text" value="${escapeHtml(row.title || "")}"></label>
            <label>Link Href<input class="input" data-field="row-href" type="text" value="${escapeHtml(row.href || "")}"></label>
            <label>Pieces/Panel<input class="input" data-field="row-pieces" type="text" value="${escapeHtml(row.pieces || "")}"></label>
          `;
          rowsStack.appendChild(rowEl);
        });

        const actions = document.createElement("div");
        actions.className = "row-actions";
        actions.innerHTML = `
          <button class="btn secondary" data-action="add-collection-row" type="button">Add Row</button>
        `;
        rowsWrap.appendChild(actions);
        panelCollection.appendChild(rowsWrap);
      }

      const tpl = state.template || defaultTemplate();
      panelTemplate.querySelector('[data-field="tpl-analytics"]').value = tpl.analyticsHtml || "";
      panelTemplate.querySelector('[data-field="tpl-default-keywords"]').value = tpl.defaultKeywords || "";
      panelTemplate.querySelector('[data-field="tpl-default-description"]').value = tpl.defaultDescription || "";
      panelTemplate.querySelector('[data-field="tpl-footer"]').value = tpl.footerText || "";
      panelTemplate.querySelector('[data-field="tpl-css-board"]').value = tpl.cssHrefBoard || "";
      panelTemplate.querySelector('[data-field="tpl-css-collection"]').value = tpl.cssHrefCollection || "";
      panelTemplate.querySelector('[data-field="tpl-js-board"]').value = tpl.jsHrefBoard || "";
      panelTemplate.querySelector('[data-field="tpl-favicon"]').value = tpl.faviconHref || "";
      panelTemplate.querySelector('[data-field="tpl-version"]').value = tpl.versionStamp || "";
      panelTemplate.querySelector('[data-field="tpl-date"]').value = tpl.dateStamp || "";

      panelContent.querySelector('[data-field="meta-title"]').value = data.meta.title || "";
      panelContent.querySelector('[data-field="meta-description"]').value = data.meta.description || "";
      panelContent.querySelector('[data-field="meta-keywords"]').value = data.meta.keywords || "";
      panelContent.querySelector('[data-field="meta-h1"]').value = data.meta.h1 || "";
      panelContent.querySelector('[data-field="meta-slogan"]').value = data.meta.slogan || "";
      if(data.type !== "board"){
        panelContent.querySelector('[data-field="meta-slogan"]').closest("label").style.display = "none";
        panelContent.querySelector('[data-field="meta-description"]').closest("label").style.display = "none";
      }

      const navList = panelContent.querySelector("[data-nav-list]");
      (data.nav || []).forEach(item => {
        const row = document.createElement("div");
        row.className = "inline-row";
        row.dataset.navItem = "true";
        row.innerHTML = `
          <label>Link Text<input class="input" data-field="nav-text" type="text" value="${escapeHtml(item.text)}"></label>
          <label>Link Href<input class="input" data-field="nav-href" type="text" value="${escapeHtml(item.href)}"></label>
        `;
        navList.appendChild(row);
      });

      const aiSelect = panelAssist.querySelector('[data-field="ai-target"]');
      aiSelect.innerHTML = "";
      if(data.type === "collection"){
        aiSelect.innerHTML = `<option value="collection-rows">Collection Rows</option>`;
      }else{
        (data.sections || []).forEach(section => {
          const label = section.tabLabel ? `${section.id} (${section.tabLabel})` : section.id;
          const opt = document.createElement("option");
          opt.value = section.id;
          opt.textContent = label;
          aiSelect.appendChild(opt);
        });
      }

      const tabs = $("formTabs");
      if(data.type === "collection"){
        tabs.querySelector('[data-tab="sections"]').style.display = "none";
        tabs.querySelector('[data-tab="collection"]').style.display = "inline-flex";
      }else{
        tabs.querySelector('[data-tab="sections"]').style.display = "inline-flex";
        tabs.querySelector('[data-tab="collection"]').style.display = "none";
      }
    }

    function collectFormState(){
      const panelTemplate = $("panel-template");
      const panelContent = $("panel-content");
      const panelSections = $("panel-sections");
      const panelCollection = $("panel-collection");
      const panelAssist = $("panel-assist");
      const meta = {
        title: panelContent.querySelector('[data-field="meta-title"]').value.trim(),
        description: panelContent.querySelector('[data-field="meta-description"]').value.trim(),
        keywords: panelContent.querySelector('[data-field="meta-keywords"]').value.trim(),
        h1: panelContent.querySelector('[data-field="meta-h1"]').value.trim(),
        slogan: panelContent.querySelector('[data-field="meta-slogan"]').value.trim()
      };

      const nav = Array.from(panelContent.querySelectorAll("[data-nav-item]")).map(row => ({
        text: row.querySelector('[data-field="nav-text"]').value.trim(),
        href: row.querySelector('[data-field="nav-href"]').value.trim()
      })).filter(item => item.text || item.href);

      if(state.formState?.type === "collection"){
        const rows = Array.from(panelCollection.querySelectorAll("[data-collection-row]")).map(row => ({
          partNo: row.querySelector('[data-field="row-part"]').value.trim(),
          title: row.querySelector('[data-field="row-title"]').value.trim(),
          href: row.querySelector('[data-field="row-href"]').value.trim(),
          pieces: row.querySelector('[data-field="row-pieces"]').value.trim()
        })).filter(row => row.partNo || row.title || row.href || row.pieces);
        return { type: "collection", meta, nav, rows };
      }

      const sections = Array.from(panelSections.querySelectorAll(".section-card")).map(card => {
        const id = card.dataset.sectionId || "";
        const title = card.dataset.sectionTitle || "";
        const tabLabel = card.dataset.sectionTab || "";
        const group = card.closest(".section-group");
        const visible = group ? group.dataset.visible !== "false" : true;
        const type = card.dataset.sectionType;
        if(type === "details"){
          const rows = Array.from(card.querySelectorAll("[data-detail-row]")).map(row => ({
            label: row.querySelector('[data-field="detail-label"]').value.trim(),
            value: row.querySelector('[data-field="detail-value"]').value.trim()
          })).filter(row => row.label || row.value);
          return { id, title, tabLabel, hidden: !visible, type, rows };
        }
        if(type === "images"){
          const images = Array.from(card.querySelectorAll("[data-image-row]")).map(row => ({
            src: row.querySelector('[data-field="image-src"]').value.trim(),
            alt: row.querySelector('[data-field="image-alt"]').value.trim(),
            full: row.querySelector('[data-field="image-full"]').value.trim()
          })).filter(img => img.src || img.alt || img.full);
          return { id, title, tabLabel, hidden: !visible, type, images };
        }
        if(type === "downloads"){
          const items = Array.from(card.querySelectorAll("[data-download-row]")).map(row => ({
            label: row.querySelector('[data-field="download-label"]').value.trim(),
            href: row.querySelector('[data-field="download-href"]').value.trim()
          })).filter(item => item.label || item.href);
          return { id, title, tabLabel, hidden: !visible, type, items };
        }
        if(type === "videos"){
          const videos = Array.from(card.querySelectorAll("[data-video-row]")).map(row => ({
            src: row.querySelector('[data-field="video-src"]').value.trim(),
            title: row.querySelector('[data-field="video-title"]').value.trim(),
            width: row.querySelector('[data-field="video-width"]').value.trim(),
            height: row.querySelector('[data-field="video-height"]').value.trim()
          })).filter(video => video.src || video.title);
          return { id, title, tabLabel, hidden: !visible, type, videos };
        }
        if(type === "revisions"){
          const rows = Array.from(card.querySelectorAll("[data-revision-row]")).map(row => ({
            date: row.querySelector('[data-field="rev-date"]').value.trim(),
            rev: row.querySelector('[data-field="rev-id"]').value.trim(),
            desc: row.querySelector('[data-field="rev-desc"]').value.trim(),
            by: row.querySelector('[data-field="rev-by"]').value.trim()
          })).filter(row => row.date || row.rev || row.desc || row.by);
          return { id, title, tabLabel, hidden: !visible, type, rows };
        }
        if(type === "ai-seeds"){
          const jsonText = card.querySelector('[data-field="ai-seeds"]').value.trim() || "{}";
          return { id, title, tabLabel, hidden: true, type, jsonText };
        }
        const bodyHtml = card.querySelector('[data-field="section-body"]').value;
        return { id, title, tabLabel, hidden: !visible, type, bodyHtml };
      });

      return { type: "board", meta, nav, sections };
    }

    function collectTemplateState(){
      const panelTemplate = $("panel-template");
      return {
        analyticsHtml: panelTemplate.querySelector('[data-field="tpl-analytics"]').value.trim(),
        defaultKeywords: panelTemplate.querySelector('[data-field="tpl-default-keywords"]').value.trim(),
        defaultDescription: panelTemplate.querySelector('[data-field="tpl-default-description"]').value.trim(),
        footerText: panelTemplate.querySelector('[data-field="tpl-footer"]').value.trim(),
        cssHrefBoard: panelTemplate.querySelector('[data-field="tpl-css-board"]').value.trim(),
        cssHrefCollection: panelTemplate.querySelector('[data-field="tpl-css-collection"]').value.trim(),
        jsHrefBoard: panelTemplate.querySelector('[data-field="tpl-js-board"]').value.trim(),
        faviconHref: panelTemplate.querySelector('[data-field="tpl-favicon"]').value.trim(),
        versionStamp: panelTemplate.querySelector('[data-field="tpl-version"]').value.trim(),
        dateStamp: panelTemplate.querySelector('[data-field="tpl-date"]').value.trim()
      };
    }

    function updateModifiedState(){
      const current = state.current?.path;
      if(!current){
        setStatus("ok", "CLEAN");
        return;
      }
      const draft = loadDraft(current);
      if(state.editorText !== state.originalText){
        setStatus(draft ? "warn" : "warn", draft ? "Draft saved" : "Modified");
        setSaveDirty(true);
      }else{
        setStatus("ok", "CLEAN");
        setSaveDirty(false);
      }
    }

    function runUpdate(){
      if(!state.current) return;
      const template = collectTemplateState();
      saveTemplate(template);
      const data = collectFormState();
      const updated = data.type === "collection"
        ? generateCollectionHtml(data, template)
        : generateBoardHtml(data, template);
      state.editorText = updated;
      saveDraft(state.current.path, state.editorText);
      updateModifiedState();
      logTerminal("update", `Updated ${state.current.path}`);
    }

    function runSave(){
      runUpdate();
    }

    function runCommand(input){
      const raw = (input || "").trim();
      if(!raw) return;
      const [cmd, ...rest] = raw.split(" ");
      const arg = rest.join(" ").trim();
      switch(cmd.toLowerCase()){
        case "save":
          runSave();
          break;
        case "ai":
          logTerminal("ai", arg ? `Received: ${arg}` : "AI not connected.");
          break;
        case "help":
          logTerminal("help", "Commands: save, ai <text>");
          break;
        default:
          logTerminal("error", `Unknown command: ${cmd}`);
      }
    }

    async function fetchFile(entry){
      const url = entry.path + "?v=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok){
        throw new Error(`Failed to load ${entry.path} (${res.status})`);
      }
      return res.text();
    }

    async function selectEntry(entry){
      try{
        state.current = entry;
        $("previewTitle").textContent = entry.title || entry.url;
        updatePreviewMeta(entry);
        setStatus("ok", "Loading...");
        const text = await fetchFile(entry);
        state.originalText = text;
        const draft = loadDraft(entry.path);
        state.editorText = draft && draft !== text ? draft : text;
        syncFormInputs(state.editorText);
        updateModifiedState();
        renderList();
      }catch(err){
        setStatus("err", err?.message || "Load error");
      }
    }

    function downloadCurrent(){
      if(!state.current) return;
      const blob = new Blob([state.editorText], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = state.current.url.split("/").pop() || "page.html";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function setupEditor(){
      const tabs = $("formTabs");
      if(tabs){
        tabs.addEventListener("click", (e) => {
          const btn = e.target.closest(".form-tab");
          if(!btn) return;
          const target = btn.getAttribute("data-tab");
          tabs.querySelectorAll(".form-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          document.querySelectorAll(".form-panel").forEach(panel => {
            panel.classList.toggle("active", panel.id === `panel-${target}`);
          });
        });
      }

      document.addEventListener("click", (e) => {
        const tabBtn = e.target.closest(".section-tab");
        if(!tabBtn) return;
        const container = tabBtn.closest(".panel-card");
        if(!container) return;
        if(e.shiftKey && tabBtn.getAttribute("data-subtab") !== "add-new"){
          const group = container.querySelector(`.section-group[data-subtab="${tabBtn.getAttribute("data-subtab")}"]`);
          if(!group) return;
          const card = group.querySelector(".section-card");
          if(!card) return;
          state.editingSectionCard = card;
          $("sectionIdInput").value = card.dataset.sectionId || "";
          $("sectionTabInput").value = card.dataset.sectionTab || "";
          $("sectionTitleInput").value = card.dataset.sectionTitle || "";
          $("sectionModal").classList.add("open");
          return;
        }
        if(tabBtn.getAttribute("data-subtab") === "add-new"){
          const groups = container.querySelectorAll(".section-group");
          const count = groups.length + 1;
          const newId = `section-${Date.now().toString(36)}-${count}`;
          const tabsRow = container.querySelector("#sectionTabs");
          const newTab = document.createElement("button");
          newTab.className = "section-tab active visible";
          newTab.type = "button";
          newTab.dataset.subtab = newId;
          newTab.textContent = "New Section";
          const addNew = container.querySelector('.section-tab[data-subtab="add-new"]');
          if(addNew && tabsRow){
            tabsRow.insertBefore(newTab, addNew.nextSibling);
          }

          const newGroup = document.createElement("div");
          newGroup.className = "section-group active";
          newGroup.dataset.subtab = newId;
          newGroup.dataset.visible = "true";
          const stack = container.querySelector(".form-stack");
          if(stack) stack.appendChild(newGroup);

          const card = document.createElement("div");
          card.className = "section-card";
          card.dataset.sectionId = newId;
          card.dataset.sectionType = "html";
          card.dataset.sectionTitle = "New Section";
          card.dataset.sectionTab = "New Section";
          card.innerHTML = `
            <div class="badge-row">
              <span class="badge-pill">${escapeHtml(newId)}</span>
              <span class="badge-pill">New Section</span>
              <span class="badge-pill">New Section</span>
            </div>
          `;
          const label = document.createElement("label");
          label.innerHTML = `Body HTML<textarea class="input" data-field="section-body"><p>New section content.</p></textarea>`;
          card.appendChild(label);
          newGroup.appendChild(card);
          container.querySelectorAll(".section-tab").forEach(b => b.classList.remove("active"));
          newTab.classList.add("active");
          groups.forEach(group => {
            group.classList.toggle("active", group.dataset.subtab === newId);
          });
          newGroup.classList.add("active");
          return;
        }
        const target = tabBtn.getAttribute("data-subtab");
        container.querySelectorAll(".section-tab").forEach(b => b.classList.remove("active"));
        tabBtn.classList.add("active");
        container.querySelectorAll(".section-group").forEach(group => {
          group.classList.toggle("active", group.dataset.subtab === target);
        });
      });

      document.addEventListener("dblclick", (e) => {
        const tabBtn = e.target.closest(".section-tab");
        if(!tabBtn) return;
        const container = tabBtn.closest(".panel-card");
        if(!container) return;
        const target = tabBtn.getAttribute("data-subtab");
        const group = container.querySelector(`.section-group[data-subtab="${target}"]`);
        if(!group) return;
        const nextVisible = group.dataset.visible === "false";
        group.dataset.visible = nextVisible ? "true" : "false";
        tabBtn.classList.toggle("visible", nextVisible);
        tabBtn.classList.toggle("hidden", !nextVisible);
      });

      document.addEventListener("contextmenu", (e) => {
        const tabBtn = e.target.closest(".section-tab");
        if(!tabBtn) return;
        const target = tabBtn.getAttribute("data-subtab");
        if(target === "add-new") return;
        e.preventDefault();
        contextTargetTab = tabBtn;
        const menu = $("sectionContextMenu");
        menu.style.display = "block";
        menu.style.left = `${e.clientX}px`;
        menu.style.top = `${e.clientY}px`;
      });

      document.addEventListener("click", (e) => {
        const menu = $("sectionContextMenu");
        if(menu && menu.style.display === "block" && !menu.contains(e.target)){
          menu.style.display = "none";
        }
      });

      $("sectionDeleteBtn").addEventListener("click", () => {
        if(!contextTargetTab) return;
        const tabBtn = contextTargetTab;
        const target = tabBtn.getAttribute("data-subtab");
        const container = tabBtn.closest(".panel-card");
        if(!container) return;
        const group = container.querySelector(`.section-group[data-subtab="${target}"]`);
        if(group) group.remove();
        tabBtn.remove();
        contextTargetTab = null;
        const menu = $("sectionContextMenu");
        if(menu) menu.style.display = "none";
        const nextTab = container.querySelector(".section-tab");
        if(nextTab){
          nextTab.classList.add("active");
          const nextTarget = nextTab.getAttribute("data-subtab");
          container.querySelectorAll(".section-group").forEach(el => {
            el.classList.toggle("active", el.dataset.subtab === nextTarget);
          });
        }
      });
      $("searchInput").addEventListener("input", (e) => filterList(e.target.value));
      $("saveBtn").addEventListener("click", runSave);

      document.addEventListener("click", (e) => {
        const target = e.target.closest("[data-action]");
        if(!target) return;
        const action = target.getAttribute("data-action");
        if(action === "add-nav"){
          const list = $("panel-content").querySelector("[data-nav-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.navItem = "true";
          row.innerHTML = `
            <label>Link Text<input class="input" data-field="nav-text" type="text"></label>
            <label>Link Href<input class="input" data-field="nav-href" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-detail"){
          const card = target.closest(".section-card");
          const list = card.querySelector("[data-detail-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.detailRow = "true";
          row.innerHTML = `
            <label>Label<input class="input" data-field="detail-label" type="text"></label>
            <label>Value<input class="input" data-field="detail-value" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-image"){
          const card = target.closest(".section-card");
          const list = card.querySelector("[data-image-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.imageRow = "true";
          row.innerHTML = `
            <label>Image Src<input class="input" data-field="image-src" type="text"></label>
            <label>Alt Text<input class="input" data-field="image-alt" type="text"></label>
            <label>Full Src<input class="input" data-field="image-full" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-download"){
          const card = target.closest(".section-card");
          const list = card.querySelector("[data-download-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.downloadRow = "true";
          row.innerHTML = `
            <label>Label<input class="input" data-field="download-label" type="text"></label>
            <label>Href<input class="input" data-field="download-href" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-video"){
          const card = target.closest(".section-card");
          const list = card.querySelector("[data-video-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.videoRow = "true";
          row.innerHTML = `
            <label>Video URL<input class="input" data-field="video-src" type="text"></label>
            <label>Title<input class="input" data-field="video-title" type="text"></label>
            <label>Width<input class="input" data-field="video-width" type="text" value="560"></label>
            <label>Height<input class="input" data-field="video-height" type="text" value="315"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-revision"){
          const card = target.closest(".section-card");
          const list = card.querySelector("[data-revision-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.revisionRow = "true";
          row.innerHTML = `
            <label>Date<input class="input" data-field="rev-date" type="text" placeholder="YYYY-MM-DD"></label>
            <label>Revision<input class="input" data-field="rev-id" type="text"></label>
            <label>Description<input class="input" data-field="rev-desc" type="text"></label>
            <label>By<input class="input" data-field="rev-by" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-collection-row"){
          const list = $("panel-collection").querySelector("[data-collection-list]");
          if(!list) return;
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.collectionRow = "true";
          row.innerHTML = `
            <label>Part No<input class="input" data-field="row-part" type="text"></label>
            <label>Title<input class="input" data-field="row-title" type="text"></label>
            <label>Link Href<input class="input" data-field="row-href" type="text"></label>
            <label>Pieces/Panel<input class="input" data-field="row-pieces" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "tpl-save"){
          const next = collectTemplateState();
          saveTemplate(next);
          logTerminal("template", "Template saved");
        }
        if(action === "tpl-load"){
          if(!state.current) return;
          const next = extractTemplateFromHtml(state.editorText);
          saveTemplate(next);
          renderForm(state.formState);
          logTerminal("template", "Template loaded from file");
        }
        if(action === "ai-draft"){
          const input = $("panel-assist").querySelector('[data-field="ai-input"]').value.trim();
          const targetSelect = $("panel-assist").querySelector('[data-field="ai-target"]');
          const targetId = targetSelect ? targetSelect.value : "";
          if(state.formState?.type === "collection"){
            return;
          }
          const card = $("panel-sections").querySelector(`.section-card[data-section-id="${CSS.escape(targetId)}"]`);
          if(!card) return;
          const type = card.dataset.sectionType;
          if(type === "html"){
            const area = card.querySelector('[data-field="section-body"]');
            if(area){
              const metaTitle = $("panel-content").querySelector('[data-field="meta-h1"]').value.trim();
              const slogan = $("panel-content").querySelector('[data-field="meta-slogan"]').value.trim();
              const details = Array.from($("panel-sections").querySelectorAll('[data-detail-row]')).map(row => {
                const label = row.querySelector('[data-field="detail-label"]').value.trim();
                const value = row.querySelector('[data-field="detail-value"]').value.trim();
                return label && value ? `${label}: ${value}` : "";
              }).filter(Boolean);
              const draft = input || `The ${metaTitle} board is designed for hands-on exploration. ${slogan} ${details.length ? "Key specs: " + details.join(", ") + "." : ""}`;
              area.value = `<p>${escapeHtml(draft)}</p>`;
            }
          }
        }
        if(action === "ai-rows"){
          const input = $("panel-assist").querySelector('[data-field="ai-input"]').value.trim();
          if(!input) return;
          if(state.formState?.type === "collection"){
            const list = $("panel-collection").querySelector("[data-collection-list]");
            if(!list) return;
            const lines = input.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
            lines.forEach(line => {
              const parts = line.split(/[|,]/).map(p => p.trim());
              const row = document.createElement("div");
              row.className = "inline-row";
              row.dataset.collectionRow = "true";
              row.innerHTML = `
                <label>Part No<input class="input" data-field="row-part" type="text" value="${escapeHtml(parts[0] || "")}"></label>
                <label>Title<input class="input" data-field="row-title" type="text" value="${escapeHtml(parts[1] || "")}"></label>
                <label>Link Href<input class="input" data-field="row-href" type="text" value="${escapeHtml(parts[2] || "")}"></label>
                <label>Pieces/Panel<input class="input" data-field="row-pieces" type="text" value="${escapeHtml(parts[3] || "")}"></label>
              `;
              list.appendChild(row);
            });
          }
        }
      });

      $("commandRunBtn").addEventListener("click", () => {
        const input = $("commandInput");
        runCommand(input.value);
        input.value = "";
      });

      $("commandInput").addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          const input = e.target;
          runCommand(input.value);
          input.value = "";
        }
      });

      $("terminalSendBtn").addEventListener("click", () => {
        const input = $("terminalInput");
        runCommand(`ai ${input.value}`);
        input.value = "";
      });

      $("terminalInput").addEventListener("keydown", (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          const input = e.target;
          runCommand(`ai ${input.value}`);
          input.value = "";
        }
      });

      $("prefsBtn").addEventListener("click", () => {
        $("baseDirInput").value = state.baseDir || "draft/";
        $("terminalDockInput").value = getTerminalDock();
        $("prefsModal").classList.add("open");
      });

      $("prefsCancel").addEventListener("click", () => {
        $("prefsModal").classList.remove("open");
      });

      $("prefsSave").addEventListener("click", () => {
        const next = $("baseDirInput").value;
        setBaseDir(next);
        setTerminalDock($("terminalDockInput").value);
        $("prefsModal").classList.remove("open");
        init();
      });

      $("sectionCancel").addEventListener("click", () => {
        state.editingSectionCard = null;
        $("sectionModal").classList.remove("open");
      });

      $("sectionSave").addEventListener("click", () => {
        const card = state.editingSectionCard;
        if(!card) return;
        card.dataset.sectionId = $("sectionIdInput").value.trim() || card.dataset.sectionId;
        card.dataset.sectionTab = $("sectionTabInput").value.trim();
        card.dataset.sectionTitle = $("sectionTitleInput").value.trim();
        const pills = [];
        if(card.dataset.sectionId) pills.push(`<span class="badge-pill">${escapeHtml(card.dataset.sectionId)}</span>`);
        if(card.dataset.sectionTab) pills.push(`<span class="badge-pill">${escapeHtml(card.dataset.sectionTab)}</span>`);
        if(card.dataset.sectionTitle) pills.push(`<span class="badge-pill">${escapeHtml(card.dataset.sectionTitle)}</span>`);
        const badgeRow = card.querySelector(".badge-row");
        if(badgeRow) badgeRow.innerHTML = pills.join("");
        $("sectionModal").classList.remove("open");
        state.editingSectionCard = null;
      });
    }

    async function init(){
      try{
        state.template = loadTemplate();
        state.baseDir = getBaseDir();
        const ok = await ensureIndexLoaded();
        state.entries = listFromIndex(state.baseDir);
        state.filtered = state.entries.slice();
        $("fileCount").textContent = `${state.filtered.length} files`;
        if(ok && state.entries.length){
          setDataStatus(true, "Index: draft");
        }else{
          setDataStatus(false, "Index: missing");
        }
        renderList();
        applyTerminalDock(getTerminalDock());
        logTerminal("system", "Ready");
      }catch(err){
        setDataStatus(false, "Index: missing");
      }
    }

    setupEditor();
    init();
  </script>
</body>
</html>
