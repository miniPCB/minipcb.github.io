<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Website Editor</title>
  <style>
    :root{
      --bg: #0f141b;
      --bg-soft: #141b24;
      --panel: #1b2430;
      --panel-2: #202b3a;
      --text: #e6edf3;
      --muted: #a6b4c3;
      --accent: #7bdcb5;
      --accent-2: #66a3ff;
      --danger: #ff7b7b;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 14px;
      --mono: "Cascadia Mono", "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      --sans: "Space Grotesk", "Trebuchet MS", "Segoe UI", sans-serif;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(102,163,255,0.25), transparent 60%),
        radial-gradient(1000px 600px at 90% 10%, rgba(123,220,181,0.2), transparent 65%),
        var(--bg);
    }

    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:22px 28px 16px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(8px);
      background: rgba(15,20,27,0.75);
      position: sticky;
      top:0;
      z-index:10;
    }

    .title{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:22px;
      font-weight:600;
      letter-spacing:0.4px;
    }

    .title .badge{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:1px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .layout{
      flex:1;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px 22px 26px;
      min-height:0;
      overflow:hidden;
    }

    aside{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .sidebar-head{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
    }

    .sidebar-head .label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.9px;
      color: var(--muted);
      margin-bottom:8px;
    }

    .search{
      display:flex;
      align-items:center;
      gap:8px;
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
    }

    .search input{
      background: transparent;
      border: none;
      color: var(--text);
      width:100%;
      font-size:14px;
      outline:none;
    }

    .meta-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
    }

    .pill{
      padding:3px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,0.03);
    }

    .file-list{
      overflow:auto;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
      min-height:0;
    }

    .file-item{
      border:1px solid transparent;
      border-radius:12px;
      padding:10px 12px;
      background: rgba(255,255,255,0.02);
      cursor:pointer;
      transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }

    .file-item:hover{
      border-color: rgba(123,220,181,0.4);
      transform: translateY(-1px);
      background: rgba(123,220,181,0.08);
    }

    .file-item.active{
      border-color: rgba(102,163,255,0.8);
      background: rgba(102,163,255,0.15);
      box-shadow: inset 0 0 0 1px rgba(102,163,255,0.35);
    }

    .file-item .name{
      font-weight:600;
      font-size:12px;
      font-family: var(--mono);
      word-break: break-word;
    }

    main{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }

    .preview-head{
      padding:18px 20px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(32,43,58,0.5);
    }

    .preview-title{
      font-size:18px;
      font-weight:600;
    }

    .preview-meta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color: var(--muted);
      font-size:12px;
    }

    .toolbar{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding:6px 12px;
      border-radius:10px;
      font-size:12px;
      letter-spacing:0.4px;
      text-transform:uppercase;
      cursor:pointer;
      transition: all 0.12s ease;
    }

    .btn:hover{
      border-color: rgba(102,163,255,0.6);
      background: rgba(102,163,255,0.15);
    }

    .btn.secondary{
      color: var(--muted);
    }

    .preview{
      padding:18px 20px 22px;
      overflow:auto;
      min-height:0;
      flex:1;
    }

    .panel-card{
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.03);
      padding:12px;
      min-height:0;
    }

    .panel-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      color: var(--muted);
      margin-bottom:10px;
    }

    .form-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }

    .form-stack{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .section-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background: rgba(255,255,255,0.02);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .inline-row{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:10px;
    }

    .row-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .tiny{
      font-size:11px;
      color: var(--muted);
    }

    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color: var(--muted);
    }

    .input, textarea{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font: inherit;
    }

    textarea{
      font-family: var(--mono);
      font-size:12px;
      min-height:300px;
      resize: vertical;
    }

    .panel-actions{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .status{
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .status.ok{ background: rgba(123,220,181,0.12); color: var(--accent); border:1px solid rgba(123,220,181,0.35); }
    .status.warn{ background: rgba(255,205,123,0.12); color: #ffd27b; border:1px solid rgba(255,205,123,0.35); }
    .status.err{ background: rgba(255,123,123,0.12); color: var(--danger); border:1px solid rgba(255,123,123,0.35); }

    .empty{
      color: var(--muted);
      font-size:14px;
      padding:18px;
      border:1px dashed var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.02);
    }

    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
    }

    .modalBack.open{
      display:flex;
    }

    .modal{
      width: min(520px, 96vw);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .modal h3{
      margin: 0 0 12px;
      font-size: 18px;
    }

    .modalGrid{
      display: grid;
      gap: 10px;
    }

    .modalActions{
      margin-top: 14px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      aside{ order:2; }
      main{ order:1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        Website Editor
        <span class="badge">Form + HTML</span>
      </div>
    </header>

    <div class="layout">
      <aside>
        <div class="sidebar-head">
          <div class="label">HTML Files</div>
          <div class="search">
            <input id="searchInput" type="search" placeholder="Filter by filename or title..." />
          </div>
          <div class="meta-row">
            <span class="pill" id="fileCount">Loading...</span>
            <span class="pill" id="dataStatus">Index: pending</span>
          </div>
        </div>
        <div class="file-list" id="fileList"></div>
      </aside>

      <main>
        <div class="preview-head">
          <div class="preview-title" id="previewTitle">Select an HTML file</div>
          <div class="preview-meta" id="previewMeta"></div>
          <div class="toolbar">
            <a class="btn secondary" id="openLink" href="#" target="_blank" rel="noopener">Open</a>
            <button class="btn" id="reloadBtn" type="button">Reload Source</button>
            <button class="btn" id="revertBtn" type="button">Revert Draft</button>
            <button class="btn" id="downloadBtn" type="button">Download HTML</button>
            <button class="btn secondary" id="prefsBtn" type="button">Preferences</button>
            <button class="btn" id="applyFormBtn" type="button">Apply Form to HTML</button>
            <button class="btn secondary" id="syncFormBtn" type="button">Rebuild Form</button>
            <span class="status ok" id="editStatus">Idle</span>
          </div>
        </div>
        <div class="preview">
          <div class="form-stack" id="formContainer"></div>
        </div>
      </main>
    </div>
  </div>

  <div class="modalBack" id="prefsModal">
    <div class="modal">
      <h3>Preferences</h3>
      <div class="modalGrid">
        <label>
          Default directory
          <input class="input" id="baseDirInput" type="text" placeholder="draft/" />
        </label>
        <div class="empty">
          This path prefixes file loads and preview links. Default is <strong>draft/</strong>.
        </div>
      </div>
      <div class="modalActions">
        <button class="btn secondary" id="prefsCancel" type="button">Cancel</button>
        <button class="btn" id="prefsSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <script src="draft/html_index.js"></script>
  <script>
    const PREFS_KEY = "websiteEditorBaseDir";
    const LOCAL_PREFIX = "websiteEditorDraft::";
    const SAVE_DELAY = 600;

    const state = {
      entries: [],
      filtered: [],
      current: null,
      originalText: "",
      editorText: "",
      saveTimer: null,
      baseDir: "draft/",
      formState: null
    };

    const $ = (id) => document.getElementById(id);

    function escapeHtml(str){
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setStatus(kind, message){
      const el = $("editStatus");
      el.textContent = message;
      el.className = "status " + kind;
    }

    function setDataStatus(ok, message){
      const el = $("dataStatus");
      el.textContent = message;
      el.className = ok ? "pill status ok" : "pill status err";
    }

    function normalizeBaseDir(value){
      const trimmed = String(value || "").trim();
      if(!trimmed) return "";
      return trimmed.endsWith("/") ? trimmed : trimmed + "/";
    }

    function getBaseDir(){
      const stored = localStorage.getItem(PREFS_KEY);
      return normalizeBaseDir(stored || state.baseDir);
    }

    function setBaseDir(next){
      const normalized = normalizeBaseDir(next);
      state.baseDir = normalized || "draft/";
      localStorage.setItem(PREFS_KEY, state.baseDir);
    }

    function loadDraft(path){
      return localStorage.getItem(LOCAL_PREFIX + path);
    }

    function saveDraft(path, text){
      localStorage.setItem(LOCAL_PREFIX + path, text);
    }

    function clearDraft(path){
      localStorage.removeItem(LOCAL_PREFIX + path);
    }

    function listFromIndex(baseDir){
      const src = Array.isArray(window.DRAFT_HTML_INDEX) ? window.DRAFT_HTML_INDEX : [];
      return src
        .filter(path => typeof path === "string" && path.toLowerCase().endsWith(".html"))
        .map(path => {
          const rel = path.replace(/^\.\//, "");
          return {
            rel,
            url: rel,
            path: baseDir + rel,
            title: rel
          };
        })
        .sort((a, b) => a.rel.localeCompare(b.rel));
    }

    function renderList(){
      const list = $("fileList");
      list.innerHTML = "";
      if(!state.filtered.length){
        list.innerHTML = '<div class="empty">No files match the filter.</div>';
        return;
      }

      state.filtered.forEach(entry => {
        const item = document.createElement("div");
        item.className = "file-item" + (state.current && state.current.url === entry.url ? " active" : "");
        item.innerHTML = `<div class="name">${escapeHtml(entry.rel || entry.path)}</div>`;
        item.addEventListener("click", () => selectEntry(entry));
        list.appendChild(item);
      });
    }

    function filterList(query){
      const q = query.trim().toLowerCase();
      if(!q){
        state.filtered = state.entries.slice();
      }else{
        state.filtered = state.entries.filter(e => {
          return (e.rel || "").toLowerCase().includes(q);
        });
      }
      $("fileCount").textContent = `${state.filtered.length} files`;
      renderList();
    }

    function updatePreviewMeta(entry){
      const meta = $("previewMeta");
      if(!entry){
        meta.innerHTML = "";
        return;
      }
      const parts = [
        `<span class="pill">${escapeHtml(entry.path)}</span>`
      ];
      meta.innerHTML = parts.join("");
    }

    function applyFormToHtml(html, formData){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      doc.title = formData.meta.title || doc.title || "";

      const metaDesc = doc.querySelector('meta[name="description"]') || doc.createElement("meta");
      metaDesc.setAttribute("name", "description");
      metaDesc.setAttribute("content", formData.meta.description || "");
      doc.head.appendChild(metaDesc);

      const metaKeywords = doc.querySelector('meta[name="keywords"]') || doc.createElement("meta");
      metaKeywords.setAttribute("name", "keywords");
      metaKeywords.setAttribute("content", formData.meta.keywords || "");
      doc.head.appendChild(metaKeywords);

      const h1 = doc.querySelector("header h1") || doc.querySelector("h1") || doc.createElement("h1");
      h1.textContent = formData.meta.h1 || "";
      if(!h1.parentElement){
        doc.body.insertBefore(h1, doc.body.firstChild);
      }

      const slogan = doc.querySelector("header .slogan") || doc.querySelector(".slogan");
      if(slogan){
        slogan.textContent = formData.meta.slogan || "";
      }

      const navList = doc.querySelector(".nav-links");
      if(navList){
        navList.innerHTML = formData.nav
          .map(item => `<li><a href="${escapeHtml(item.href)}">${escapeHtml(item.text)}</a></li>`)
          .join("");
      }

      const tabsHost = doc.querySelector(".tabs");
      if(tabsHost){
        const visibleTabs = formData.sections.filter(section => section.tabLabel);
        const firstTabId = visibleTabs.length ? visibleTabs[0].id : "";
        const tabButtons = visibleTabs.map(section => {
          const active = section.id === firstTabId ? " active" : "";
          return `<button class="tab${active}" onclick="showTab('${section.id}', this)">${escapeHtml(section.tabLabel)}</button>`;
        }).join("");
        tabsHost.innerHTML = tabButtons;
      }

      const tabContainer = doc.querySelector(".tab-container");
      if(tabContainer){
        const existing = Array.from(tabContainer.querySelectorAll(".tab-content"));
        const byId = new Map(existing.map(el => [el.id, el]));
        const firstTabSection = formData.sections.find(section => section.tabLabel) || formData.sections[0];
        const activeId = firstTabSection ? firstTabSection.id : "";
        formData.sections.forEach((section) => {
          let el = byId.get(section.id);
          if(!el){
            el = doc.createElement("div");
            el.id = section.id;
            el.className = "tab-content";
            tabContainer.appendChild(el);
          }
          el.className = "tab-content" + (section.id === activeId ? " active" : "");
          if(section.hidden){
            el.setAttribute("data-hidden", "true");
          }else{
            el.removeAttribute("data-hidden");
          }

          if(section.type === "details"){
            const rows = section.rows
              .map(row => `<p><strong>${escapeHtml(row.label)}:</strong> ${escapeHtml(row.value)}</p>`)
              .join("");
            el.innerHTML = `<h2>${escapeHtml(section.title)}</h2>${rows}`;
          }else if(section.type === "images"){
            const images = section.images.map(img => {
              const full = img.full ? ` data-full="${escapeHtml(img.full)}"` : "";
              return `<img src="${escapeHtml(img.src)}" class="zoomable" alt="${escapeHtml(img.alt)}" onclick="openLightbox(this)"${full}>`;
            }).join("");
            el.innerHTML = `<h2>${escapeHtml(section.title)}</h2><div class="lightbox-container">${images}</div>`;
          }else{
            const body = section.bodyHtml ? section.bodyHtml : "";
            el.innerHTML = `<h2>${escapeHtml(section.title)}</h2>${body}`;
          }
        });

        existing.forEach(el => {
          if(!formData.sections.find(section => section.id === el.id)){
            el.remove();
          }
        });
      }

      const doctypeMatch = html.match(/<!doctype[^>]*>/i);
      const doctype = doctypeMatch ? doctypeMatch[0] : "<!doctype html>";
      return `${doctype}\n${doc.documentElement.outerHTML}`;
    }

    function extractFormFromHtml(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const metaDesc = doc.querySelector('meta[name="description"]');
      const metaKeywords = doc.querySelector('meta[name="keywords"]');
      const h1 = doc.querySelector("header h1") || doc.querySelector("h1");
      const slogan = doc.querySelector("header .slogan") || doc.querySelector(".slogan");

      const navLinks = Array.from(doc.querySelectorAll(".nav-links a")).map(link => ({
        text: link.textContent.trim(),
        href: link.getAttribute("href") || ""
      }));

      const tabs = Array.from(doc.querySelectorAll(".tabs .tab")).map(btn => {
        const onclick = btn.getAttribute("onclick") || "";
        const match = onclick.match(/showTab\('([^']+)'/);
        return {
          id: match ? match[1] : btn.dataset.tab || "",
          label: btn.textContent.trim()
        };
      });
      const tabById = new Map(tabs.map(tab => [tab.id, tab.label]));

      const sections = Array.from(doc.querySelectorAll(".tab-content")).map((section, idx) => {
        const id = section.id || `section-${idx + 1}`;
        const hidden = section.getAttribute("data-hidden") === "true";
        const h2 = section.querySelector("h2");
        const title = h2 ? h2.textContent.trim() : id;
        const tabLabel = tabById.get(id) || "";
        if(id === "details"){
          const rows = Array.from(section.querySelectorAll("p")).map(p => {
            const strong = p.querySelector("strong");
            if(!strong) return null;
            const label = strong.textContent.replace(/:$/, "").trim();
            const value = p.textContent.replace(strong.textContent, "").trim();
            return { label, value };
          }).filter(Boolean);
          return { id, hidden, title, tabLabel, type: "details", rows };
        }

        const images = Array.from(section.querySelectorAll("img"));
        if(images.length){
          return {
            id,
            hidden,
            title,
            tabLabel,
            type: "images",
            images: images.map(img => ({
              src: img.getAttribute("src") || "",
              alt: img.getAttribute("alt") || "",
              full: img.getAttribute("data-full") || ""
            }))
          };
        }

        const clone = section.cloneNode(true);
        const cloneH2 = clone.querySelector("h2");
        if(cloneH2) cloneH2.remove();
        return {
          id,
          hidden,
          title,
          tabLabel,
          type: "html",
          bodyHtml: clone.innerHTML.trim()
        };
      });

      return {
        meta: {
          title: doc.title || "",
          description: metaDesc ? metaDesc.getAttribute("content") || "" : "",
          keywords: metaKeywords ? metaKeywords.getAttribute("content") || "" : "",
          h1: h1 ? h1.textContent.trim() : "",
          slogan: slogan ? slogan.textContent.trim() : ""
        },
        nav: navLinks,
        sections
      };
    }

    function syncFormInputs(html){
      state.formState = extractFormFromHtml(html);
      renderForm(state.formState);
    }

    function renderForm(data){
      const container = $("formContainer");
      container.innerHTML = "";

      const metaCard = document.createElement("div");
      metaCard.className = "panel-card";
      metaCard.innerHTML = `
        <div class="panel-title">Page Meta</div>
        <div class="form-grid">
          <label>Title<input class="input" data-field="meta-title" type="text"></label>
          <label>Meta Description<input class="input" data-field="meta-description" type="text"></label>
          <label>Meta Keywords<input class="input" data-field="meta-keywords" type="text"></label>
          <label>Header H1<input class="input" data-field="meta-h1" type="text"></label>
          <label>Slogan<input class="input" data-field="meta-slogan" type="text"></label>
        </div>
      `;
      container.appendChild(metaCard);

      const navCard = document.createElement("div");
      navCard.className = "panel-card";
      navCard.innerHTML = `
        <div class="panel-title">Navigation Links</div>
        <div class="form-stack" data-nav-list></div>
        <div class="row-actions">
          <button class="btn secondary" data-action="add-nav" type="button">Add Link</button>
        </div>
      `;
      container.appendChild(navCard);

      const sectionsWrap = document.createElement("div");
      sectionsWrap.className = "panel-card";
      sectionsWrap.innerHTML = `<div class="panel-title">Sections</div>`;
      container.appendChild(sectionsWrap);

      const sectionsStack = document.createElement("div");
      sectionsStack.className = "form-stack";
      sectionsWrap.appendChild(sectionsStack);

      (data.sections || []).forEach(section => {
        const card = document.createElement("div");
        card.className = "section-card";
        card.dataset.sectionId = section.id;
        card.dataset.sectionType = section.type;
        card.innerHTML = `
          <div class="inline-row">
            <label>Section ID<input class="input" data-field="section-id" type="text" value="${escapeHtml(section.id)}" readonly></label>
            <label>Tab Label<input class="input" data-field="section-tab" type="text" value="${escapeHtml(section.tabLabel || "")}"></label>
          </div>
          <div class="inline-row">
            <label>Section Title<input class="input" data-field="section-title" type="text" value="${escapeHtml(section.title || "")}"></label>
            <label>Visible<input class="input" data-field="section-visible" type="checkbox"${section.hidden ? "" : " checked"}></label>
          </div>
        `;

        if(section.type === "details"){
          const rows = document.createElement("div");
          rows.className = "form-stack";
          rows.dataset.detailList = "true";
          (section.rows || []).forEach(row => {
            const rowEl = document.createElement("div");
            rowEl.className = "inline-row";
            rowEl.dataset.detailRow = "true";
            rowEl.innerHTML = `
              <label>Label<input class="input" data-field="detail-label" type="text" value="${escapeHtml(row.label)}"></label>
              <label>Value<input class="input" data-field="detail-value" type="text" value="${escapeHtml(row.value)}"></label>
            `;
            rows.appendChild(rowEl);
          });
          card.appendChild(rows);
          const actions = document.createElement("div");
          actions.className = "row-actions";
          actions.innerHTML = `
            <button class="btn secondary" data-action="add-detail" type="button">Add Detail Row</button>
          `;
          card.appendChild(actions);
        }else if(section.type === "images"){
          const rows = document.createElement("div");
          rows.className = "form-stack";
          rows.dataset.imageList = "true";
          (section.images || []).forEach(img => {
            const rowEl = document.createElement("div");
            rowEl.className = "inline-row";
            rowEl.dataset.imageRow = "true";
            rowEl.innerHTML = `
              <label>Image Src<input class="input" data-field="image-src" type="text" value="${escapeHtml(img.src)}"></label>
              <label>Alt Text<input class="input" data-field="image-alt" type="text" value="${escapeHtml(img.alt)}"></label>
              <label>Full Src<input class="input" data-field="image-full" type="text" value="${escapeHtml(img.full || "")}"></label>
            `;
            rows.appendChild(rowEl);
          });
          card.appendChild(rows);
          const actions = document.createElement("div");
          actions.className = "row-actions";
          actions.innerHTML = `
            <button class="btn secondary" data-action="add-image" type="button">Add Image</button>
          `;
          card.appendChild(actions);
        }else{
          const label = document.createElement("label");
          label.innerHTML = `Body HTML<textarea class="input" data-field="section-body">${escapeHtml(section.bodyHtml || "")}</textarea>`;
          card.appendChild(label);
        }

        sectionsStack.appendChild(card);
      });

      container.querySelector('[data-field="meta-title"]').value = data.meta.title || "";
      container.querySelector('[data-field="meta-description"]').value = data.meta.description || "";
      container.querySelector('[data-field="meta-keywords"]').value = data.meta.keywords || "";
      container.querySelector('[data-field="meta-h1"]').value = data.meta.h1 || "";
      container.querySelector('[data-field="meta-slogan"]').value = data.meta.slogan || "";

      const navList = container.querySelector("[data-nav-list]");
      (data.nav || []).forEach(item => {
        const row = document.createElement("div");
        row.className = "inline-row";
        row.dataset.navItem = "true";
        row.innerHTML = `
          <label>Link Text<input class="input" data-field="nav-text" type="text" value="${escapeHtml(item.text)}"></label>
          <label>Link Href<input class="input" data-field="nav-href" type="text" value="${escapeHtml(item.href)}"></label>
        `;
        navList.appendChild(row);
      });
    }

    function collectFormState(){
      const container = $("formContainer");
      const meta = {
        title: container.querySelector('[data-field="meta-title"]').value.trim(),
        description: container.querySelector('[data-field="meta-description"]').value.trim(),
        keywords: container.querySelector('[data-field="meta-keywords"]').value.trim(),
        h1: container.querySelector('[data-field="meta-h1"]').value.trim(),
        slogan: container.querySelector('[data-field="meta-slogan"]').value.trim()
      };

      const nav = Array.from(container.querySelectorAll("[data-nav-item]")).map(row => ({
        text: row.querySelector('[data-field="nav-text"]').value.trim(),
        href: row.querySelector('[data-field="nav-href"]').value.trim()
      })).filter(item => item.text || item.href);

      const sections = Array.from(container.querySelectorAll(".section-card")).map(card => {
        const id = card.dataset.sectionId || card.querySelector('[data-field="section-id"]').value.trim();
        const title = card.querySelector('[data-field="section-title"]').value.trim();
        const tabLabel = card.querySelector('[data-field="section-tab"]').value.trim();
        const visible = card.querySelector('[data-field="section-visible"]').checked;
        const type = card.dataset.sectionType;
        if(type === "details"){
          const rows = Array.from(card.querySelectorAll("[data-detail-row]")).map(row => ({
            label: row.querySelector('[data-field="detail-label"]').value.trim(),
            value: row.querySelector('[data-field="detail-value"]').value.trim()
          })).filter(row => row.label || row.value);
          return { id, title, tabLabel, hidden: !visible, type, rows };
        }
        if(type === "images"){
          const images = Array.from(card.querySelectorAll("[data-image-row]")).map(row => ({
            src: row.querySelector('[data-field="image-src"]').value.trim(),
            alt: row.querySelector('[data-field="image-alt"]').value.trim(),
            full: row.querySelector('[data-field="image-full"]').value.trim()
          })).filter(img => img.src || img.alt || img.full);
          return { id, title, tabLabel, hidden: !visible, type, images };
        }
        const bodyHtml = card.querySelector('[data-field="section-body"]').value;
        return { id, title, tabLabel, hidden: !visible, type, bodyHtml };
      });

      return { meta, nav, sections };
    }

    function updateModifiedState(){
      const current = state.current?.path;
      if(!current){
        setStatus("ok", "Idle");
        return;
      }
      const draft = loadDraft(current);
      if(state.editorText !== state.originalText){
        setStatus(draft ? "warn" : "warn", draft ? "Draft saved" : "Modified");
      }else{
        setStatus("ok", "Clean");
      }
    }

    async function fetchFile(entry){
      const url = entry.path + "?v=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok){
        throw new Error(`Failed to load ${entry.path} (${res.status})`);
      }
      return res.text();
    }

    async function selectEntry(entry){
      try{
        state.current = entry;
        $("previewTitle").textContent = entry.title || entry.url;
        updatePreviewMeta(entry);
        $("openLink").href = entry.path;
        setStatus("ok", "Loading...");
        const text = await fetchFile(entry);
        state.originalText = text;
        const draft = loadDraft(entry.path);
        state.editorText = draft && draft !== text ? draft : text;
        syncFormInputs(state.editorText);
        updateModifiedState();
        renderList();
      }catch(err){
        setStatus("err", err?.message || "Load error");
      }
    }

    function downloadCurrent(){
      if(!state.current) return;
      const blob = new Blob([state.editorText], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = state.current.url.split("/").pop() || "page.html";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function setupEditor(){
      $("searchInput").addEventListener("input", (e) => filterList(e.target.value));
      $("reloadBtn").addEventListener("click", () => state.current && selectEntry(state.current));
      $("revertBtn").addEventListener("click", () => {
        if(!state.current) return;
        clearDraft(state.current.path);
        state.editorText = state.originalText;
        syncFormInputs(state.editorText);
        updateModifiedState();
      });
      $("downloadBtn").addEventListener("click", downloadCurrent);

      $("applyFormBtn").addEventListener("click", () => {
        if(!state.current) return;
        const data = collectFormState();
        const updated = applyFormToHtml(state.editorText, data);
        state.editorText = updated;
        saveDraft(state.current.path, state.editorText);
        updateModifiedState();
      });

      $("syncFormBtn").addEventListener("click", () => {
        if(!state.current) return;
        syncFormInputs(state.editorText);
      });

      $("formContainer").addEventListener("click", (e) => {
        const target = e.target.closest("[data-action]");
        if(!target) return;
        const action = target.getAttribute("data-action");
        if(action === "add-nav"){
          const list = $("formContainer").querySelector("[data-nav-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.navItem = "true";
          row.innerHTML = `
            <label>Link Text<input class="input" data-field="nav-text" type="text"></label>
            <label>Link Href<input class="input" data-field="nav-href" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-detail"){
          const card = target.closest(".section-card");
          const list = card.querySelector("[data-detail-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.detailRow = "true";
          row.innerHTML = `
            <label>Label<input class="input" data-field="detail-label" type="text"></label>
            <label>Value<input class="input" data-field="detail-value" type="text"></label>
          `;
          list.appendChild(row);
        }
        if(action === "add-image"){
          const card = target.closest(".section-card");
          const list = card.querySelector("[data-image-list]");
          const row = document.createElement("div");
          row.className = "inline-row";
          row.dataset.imageRow = "true";
          row.innerHTML = `
            <label>Image Src<input class="input" data-field="image-src" type="text"></label>
            <label>Alt Text<input class="input" data-field="image-alt" type="text"></label>
            <label>Full Src<input class="input" data-field="image-full" type="text"></label>
          `;
          list.appendChild(row);
        }
      });

      $("prefsBtn").addEventListener("click", () => {
        $("baseDirInput").value = state.baseDir || "draft/";
        $("prefsModal").classList.add("open");
      });

      $("prefsCancel").addEventListener("click", () => {
        $("prefsModal").classList.remove("open");
      });

      $("prefsSave").addEventListener("click", () => {
        const next = $("baseDirInput").value;
        setBaseDir(next);
        $("prefsModal").classList.remove("open");
        init();
      });
    }

    function init(){
      try{
        state.baseDir = getBaseDir();
        state.entries = listFromIndex(state.baseDir);
        state.filtered = state.entries.slice();
        $("fileCount").textContent = `${state.filtered.length} files`;
        setDataStatus(true, "Index: draft");
        renderList();
      }catch(err){
        setDataStatus(false, "Index: missing");
      }
    }

    setupEditor();
    init();
  </script>
</body>
</html>
